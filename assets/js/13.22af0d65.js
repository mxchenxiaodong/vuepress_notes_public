(window.webpackJsonp=window.webpackJsonp||[]).push([[13],{178:function(s,t,a){"use strict";a.r(t);var n=a(0),e=Object(n.a)({},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("div",{staticClass:"content"},[s._m(0),s._v(" "),a("p",[s._v("看过sidekiq源码的都说好。\n架构明确，注释又多，而且基本都是短方法，阅读起来比较流畅。\n真的挺好的。")]),s._v(" "),s._m(1),s._m(2),s._v(" "),a("p",[s._v("一个后台任务的处理，无非就是把相关的参数存起来慢慢执行。几个点需要注意：")]),s._v(" "),s._m(3),s._v(" "),a("p",[s._v("这几个都是需要时刻考虑的地方。")]),s._v(" "),s._m(4),s._v(" "),s._m(5),s._v(" "),s._m(6),s._v(" "),s._m(7),s._v(" "),s._m(8),s._v(" "),s._m(9),s._m(10),s._v(" "),a("p",[s._v("看源码的时候，发现里面涉及了很多不错的点。")]),s._v(" "),s._m(11),s._v(" "),s._m(12),s._v(" "),a("p",[s._v("perform_in对应的格式是：")]),s._v(" "),s._m(13),a("p",[s._v("perform_async对应的格式是：")]),s._v(" "),s._m(14),s._m(15),s._v(" "),s._m(16),s._v(" "),s._m(17),s._v(" "),s._m(18),s._m(19),s._v(" "),a("p",[s._v("sidekiq中，多处会提供自定义的能力。")]),s._v(" "),s._m(20),s._v(" "),s._m(21),s._m(22),s._v(" "),s._m(23),s._v(" "),s._m(24),s._m(25),s._v(" "),s._m(26),s._v(" "),a("p",[s._v("在sidekiq中，各个队列可以通过配置权重，实现优先级。\n写在启动参数中：")]),s._v(" "),s._m(27),a("p",[s._v("也可以写在配置文件中：")]),s._v(" "),s._m(28),s._m(29),s._v(" "),a("p",[s._v("如果想要按顺序来处理，不要指定权重即可：")]),s._v(" "),s._m(30),a("p",[s._v("如果想要各个队列随机平等处理，则配置权重都为1：")]),s._v(" "),s._m(31),a("p",[s._v("为什么会是这样？ sidekiq内部是如何处理的？\n下面来看看，会发现思路的也是很简单的。")]),s._v(" "),a("p",[s._v("sidekiq启动时，会解析传入的参数 — — 要么是带在命令行，要么是写在配置文件，就是开头说的那两种方式。")]),s._v(" "),s._m(32),a("p",[s._v("生成两个参数：")]),s._v(" "),s._m(33),s._v(" "),s._m(34),s._m(35),s._v(" "),a("p",[s._v("在弹出任务的时候，会传入这些参数。")]),s._v(" "),s._m(36),a("p",[s._v("当配有权重时，会先打乱再去重。")]),s._v(" "),s._m(37),s._v(" "),s._m(38),s._v(" "),s._m(39),s._v(" "),a("p",[s._v("这就是sidekiq处理优先级的方式。")]),s._v(" "),s._m(40),s._v(" "),s._m(41),s._v(" "),a("p",[s._v("中间件可以分两种")]),s._v(" "),s._m(42),s._v(" "),s._m(43),s._m(44),s._v(" "),s._m(45),s._m(46),s._v(" "),a("p",[s._v("如何实现？")]),s._v(" "),s._m(47),s._m(48),s._v(" "),a("p",[s._v("调用的时候：")]),s._v(" "),s._m(49),s._m(50),s._v(" "),s._m(51),s._m(52),s._v(" "),a("p",[s._v("sidekiq的中间件跟Rack的中间件定义很像：")]),s._v(" "),s._m(53),s._v(" "),s._m(54),s._m(55),s._v(" "),s._m(56),s._v(" "),s._m(57),s._v(" "),s._m(58),s._m(59),s._v(" "),s._m(60),s._m(61),a("p",[s._v("poll_interval_average => 决定延时任务定期检查的平均时间周期。\n直接看这一大段注释也可以很爽！！！！！")]),s._v(" "),s._m(62),a("p",[s._v("根据你开启的sidekiq的进程数计算")]),s._v(" "),s._m(63),s._m(64),s._v(" "),a("p",[s._v("当然，还涉及到许多其它的点，后续待跟。像：")]),s._v(" "),s._m(65),s._v(" "),a("hr"),s._v(" "),s._m(66),s._v(" "),a("p",[s._v("好文推荐，图文并茂呢，将sidekiq的处理过程讲得很明白~")]),s._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://github.com/mperham/sidekiq/wiki",target:"_blank",rel:"noopener noreferrer"}},[s._v("Home · mperham/sidekiq Wiki · GitHub"),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://draveness.me/sidekiq",target:"_blank",rel:"noopener noreferrer"}},[s._v("Sidekiq 如何处理异步任务"),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://ruby-china.org/topics/31470",target:"_blank",rel:"noopener noreferrer"}},[s._v("Sidekiq 任务调度流程分析 · Ruby China"),a("OutboundLink")],1)])])])},[function(){var s=this.$createElement,t=this._self._c||s;return t("h1",{attrs:{id:"分享之sidekiq"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#分享之sidekiq","aria-hidden":"true"}},[this._v("#")]),this._v(" 分享之sidekiq")])},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("div",{staticClass:"language-ruby line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-ruby"}},[a("code",[a("span",{attrs:{class:"token comment"}},[s._v("# launcher.rb")]),s._v("\n"),a("span",{attrs:{class:"token keyword"}},[s._v("def")]),s._v(" heartbeat\n  results "),a("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{attrs:{class:"token constant"}},[s._v("Sidekiq")]),a("span",{attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{attrs:{class:"token constant"}},[s._v("CLI")]),a("span",{attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{attrs:{class:"token constant"}},[s._v("PROCTITLES")]),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("map "),a("span",{attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{attrs:{class:"token operator"}},[s._v("|")]),s._v("x"),a("span",{attrs:{class:"token operator"}},[s._v("|")]),s._v(" x"),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{attrs:{class:"token keyword"}},[s._v("self")]),a("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" to_data"),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  results"),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("compact"),a("span",{attrs:{class:"token operator"}},[s._v("!")]),s._v("\n  $"),a("span",{attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" results"),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{attrs:{class:"token function"}},[s._v("join")]),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{attrs:{class:"token string"}},[s._v("' '")]),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n  ❤\n"),a("span",{attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n\n"),a("span",{attrs:{class:"token comment"}},[s._v("# sidekiq.rb")]),s._v("\n"),a("span",{attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),a("span",{attrs:{class:"token keyword"}},[s._v("self")]),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("❨╯°□°❩╯︵┻━┻\n  puts "),a("span",{attrs:{class:"token string"}},[s._v('"Calm down, yo."')]),s._v("\n"),a("span",{attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])])},function(){var s=this.$createElement,t=this._self._c||s;return t("h2",{attrs:{id:"注意点"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#注意点","aria-hidden":"true"}},[this._v("#")]),this._v(" 注意点")])},function(){var s=this.$createElement,t=this._self._c||s;return t("ul",[t("li",[this._v("尽可能简单的参数。（考虑内存大小）")]),this._v(" "),t("li",[this._v("可能会失败重试，是否幂等。")]),this._v(" "),t("li",[this._v("是否涉及到并发。")])])},function(){var s=this.$createElement,t=this._self._c||s;return t("h2",{attrs:{id:"处理过程"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#处理过程","aria-hidden":"true"}},[this._v("#")]),this._v(" 处理过程")])},function(){var s=this.$createElement,t=this._self._c||s;return t("h3",{attrs:{id:"几个概念"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#几个概念","aria-hidden":"true"}},[this._v("#")]),this._v(" 几个概念")])},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ol",[a("li",[s._v("Scheduled  poller => "),a("code",[s._v("Sidekiq::Scheduled::Poller")]),s._v("（拉取"),a("code",[s._v("retry：重试")]),s._v(" 跟"),a("code",[s._v("schedule：延时")]),s._v("集合的任务推入队列）")]),s._v(" "),a("li",[s._v("worker manager => "),a("code",[s._v("Sidekiq::Manager")]),s._v("（管理多个处理的任务队列的Processor）")])])},function(){var s=this.$createElement,t=this._self._c||s;return t("h3",{attrs:{id:"大致的思路"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#大致的思路","aria-hidden":"true"}},[this._v("#")]),this._v(" 大致的思路")])},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ul",[a("li",[s._v("客户端将相关任务推入队列")]),s._v(" "),a("li",[a("code",[s._v("Sidekiq::Scheduled::Poller")]),s._v("  拉取  "),a("code",[s._v("retry：重试")]),s._v(" 跟"),a("code",[s._v("schedule：延时")]),s._v("集合的任务推入队列")]),s._v(" "),a("li",[s._v("启动多个Processor处理队列任务")])])},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("div",{staticClass:"language-ruby line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-ruby"}},[a("code",[a("span",{attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),a("span",{attrs:{class:"token class-name"}},[s._v("HardWorker")]),s._v("\n  include "),a("span",{attrs:{class:"token constant"}},[s._v("Sidekiq")]),a("span",{attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{attrs:{class:"token constant"}},[s._v("Worker")]),s._v("\n  "),a("span",{attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),a("span",{attrs:{class:"token function"}},[s._v("perform")]),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("name"),a("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" count"),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),a("span",{attrs:{class:"token comment"}},[s._v("# do something")]),s._v("\n  "),a("span",{attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n"),a("span",{attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n\n"),a("span",{attrs:{class:"token constant"}},[s._v("HardWorker")]),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{attrs:{class:"token function"}},[s._v("perform_async")]),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{attrs:{class:"token string"}},[s._v("'bob'")]),a("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{attrs:{class:"token number"}},[s._v("5")]),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{attrs:{class:"token comment"}},[s._v("# 异步")]),s._v("\n"),a("span",{attrs:{class:"token constant"}},[s._v("HardWorker")]),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{attrs:{class:"token function"}},[s._v("perform_in")]),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{attrs:{class:"token number"}},[s._v("5.")]),s._v("minutes"),a("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{attrs:{class:"token string"}},[s._v("'bob'")]),a("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{attrs:{class:"token number"}},[s._v("5")]),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{attrs:{class:"token comment"}},[s._v("# 延时异步")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])])},function(){var s=this.$createElement,t=this._self._c||s;return t("h2",{attrs:{id:"几个套路"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#几个套路","aria-hidden":"true"}},[this._v("#")]),this._v(" 几个套路")])},function(){var s=this.$createElement,t=this._self._c||s;return t("h3",{attrs:{id:"处理延时任务"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#处理延时任务","aria-hidden":"true"}},[this._v("#")]),this._v(" 处理延时任务")])},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("p",[a("code",[s._v("perform_async")]),s._v(" 与 "),a("code",[s._v("perform_in")]),s._v("的调用差不用，只是背后处理的时候，"),a("code",[s._v("perform_in")]),s._v(" 会 加多一个 "),a("code",[s._v("at")]),s._v("参数。")])},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("div",{staticClass:"language-ruby line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-ruby"}},[a("code",[s._v("item "),a("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),a("span",{attrs:{class:"token string"}},[s._v("'class'")]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v("=")]),a("span",{attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{attrs:{class:"token constant"}},[s._v("HardWorker")]),a("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{attrs:{class:"token string"}},[s._v("'args'")]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v("=")]),a("span",{attrs:{class:"token operator"}},[s._v(">")]),s._v(" args"),a("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{attrs:{class:"token string"}},[s._v("'at'")]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v("=")]),a("span",{attrs:{class:"token operator"}},[s._v(">")]),s._v(" ts "),a("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])])},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("div",{staticClass:"language-ruby line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-ruby"}},[a("code",[s._v("item "),a("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),a("span",{attrs:{class:"token string"}},[s._v("'class'")]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v("=")]),a("span",{attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{attrs:{class:"token constant"}},[s._v("HardWorker")]),a("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{attrs:{class:"token string"}},[s._v("'args'")]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v("=")]),a("span",{attrs:{class:"token operator"}},[s._v(">")]),s._v(" args "),a("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])])},function(){var s=this.$createElement,t=this._self._c||s;return t("p",[this._v("然后调用"),t("code",[this._v("Sidekiq::Client.new(pool).push(item)")]),this._v("，在push根据有没有"),t("code",[this._v("at")]),this._v("字段来做出不同的处理。")])},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("blockquote",[a("p",[s._v("如果有"),a("code",[s._v("at")]),s._v("参数，加入到一个叫做"),a("code",[s._v("schedule")]),s._v("的集合中，等待 "),a("code",[s._v("Sidekiq::Scheduled::Poller")]),s._v(" 拉取 再推入相应的队列当中，再等待"),a("code",[s._v("Processor")]),s._v("的处理。")])])},function(){var s=this.$createElement,t=this._self._c||s;return t("blockquote",[t("p",[this._v("如果没有，则直接推入相应的队列当中，再等待"),t("code",[this._v("Processor")]),this._v("的处理。")])])},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("div",{staticClass:"language-ruby line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-ruby"}},[a("code",[a("span",{attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),a("span",{attrs:{class:"token function"}},[s._v("atomic_push")]),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("conn"),a("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" payloads"),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),a("span",{attrs:{class:"token keyword"}},[s._v("if")]),s._v(" payloads"),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("first"),a("span",{attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{attrs:{class:"token string"}},[s._v("'at'")]),a("span",{attrs:{class:"token punctuation"}},[s._v("]")]),s._v("  "),a("span",{attrs:{class:"token comment"}},[s._v("# ==> here")]),s._v("\n    conn"),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{attrs:{class:"token function"}},[s._v("zadd")]),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{attrs:{class:"token string"}},[s._v("'schedule'")]),a("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" payloads"),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("map "),a("span",{attrs:{class:"token keyword"}},[s._v("do")]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v("|")]),s._v("hash"),a("span",{attrs:{class:"token operator"}},[s._v("|")]),s._v("\n      at "),a("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" hash"),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{attrs:{class:"token function"}},[s._v("delete")]),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{attrs:{class:"token string"}},[s._v("'at'")]),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("to_s\n      "),a("span",{attrs:{class:"token punctuation"}},[s._v("[")]),s._v("at"),a("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{attrs:{class:"token constant"}},[s._v("Sidekiq")]),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{attrs:{class:"token function"}},[s._v("dump_json")]),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("hash"),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    "),a("span",{attrs:{class:"token keyword"}},[s._v("end")]),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),a("span",{attrs:{class:"token keyword"}},[s._v("else")]),s._v("              "),a("span",{attrs:{class:"token comment"}},[s._v("# ==> here")]),s._v("\n    q "),a("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" payloads"),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("first"),a("span",{attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{attrs:{class:"token string"}},[s._v("'queue'")]),a("span",{attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    now "),a("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{attrs:{class:"token builtin"}},[s._v("Time")]),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("now"),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("to_f\n    to_push "),a("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" payloads"),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("map "),a("span",{attrs:{class:"token keyword"}},[s._v("do")]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v("|")]),s._v("entry"),a("span",{attrs:{class:"token operator"}},[s._v("|")]),s._v("\n      entry"),a("span",{attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{attrs:{class:"token string"}},[s._v("'enqueued_at'")]),a("span",{attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" now\n      "),a("span",{attrs:{class:"token constant"}},[s._v("Sidekiq")]),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{attrs:{class:"token function"}},[s._v("dump_json")]),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("entry"),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),a("span",{attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n    conn"),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{attrs:{class:"token function"}},[s._v("sadd")]),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{attrs:{class:"token string"}},[s._v("'queues'")]),a("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" q"),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    conn"),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{attrs:{class:"token function"}},[s._v("lpush")]),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{attrs:{class:"token string"}},[s._v('"queue:'),a("span",{attrs:{class:"token interpolation"}},[a("span",{attrs:{class:"token delimiter tag"}},[s._v("#{")]),s._v("q"),a("span",{attrs:{class:"token delimiter tag"}},[s._v("}")])]),s._v('"')]),a("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" to_push"),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),a("span",{attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n"),a("span",{attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br")])])},function(){var s=this.$createElement,t=this._self._c||s;return t("h3",{attrs:{id:"策略模式"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#策略模式","aria-hidden":"true"}},[this._v("#")]),this._v(" 策略模式")])},function(){var s=this.$createElement,t=this._self._c||s;return t("ul",[t("li",[this._v("Poller拉取器 拉取任务后 推入队列的策略")])])},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("div",{staticClass:"language-ruby line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-ruby"}},[a("code",[a("span",{attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),a("span",{attrs:{class:"token class-name"}},[s._v("Enq")]),s._v("\n  "),a("span",{attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),a("span",{attrs:{class:"token function"}},[s._v("enqueue_jobs")]),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("now"),a("span",{attrs:{class:"token operator"}},[s._v("=")]),a("span",{attrs:{class:"token builtin"}},[s._v("Time")]),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("now"),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("to_f"),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("to_s"),a("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" sorted_sets"),a("span",{attrs:{class:"token operator"}},[s._v("=")]),a("span",{attrs:{class:"token constant"}},[s._v("SETS")]),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n  "),a("span",{attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n"),a("span",{attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n\n"),a("span",{attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),a("span",{attrs:{class:"token class-name"}},[s._v("Poller")]),s._v("\n  "),a("span",{attrs:{class:"token keyword"}},[s._v("def")]),s._v(" initialize\n    "),a("span",{attrs:{class:"token variable"}},[s._v("@enq")]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{attrs:{class:"token constant"}},[s._v("Sidekiq")]),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("options"),a("span",{attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{attrs:{class:"token symbol"}},[s._v(":scheduled_enq")]),a("span",{attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v("||")]),s._v(" "),a("span",{attrs:{class:"token constant"}},[s._v("Sidekiq")]),a("span",{attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{attrs:{class:"token constant"}},[s._v("Scheduled")]),a("span",{attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{attrs:{class:"token constant"}},[s._v("Enq")]),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{attrs:{class:"token keyword"}},[s._v("new")]),s._v("\n  "),a("span",{attrs:{class:"token class-name"}},[s._v("end")]),s._v("\n"),a("span",{attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n\n"),a("span",{attrs:{class:"token comment"}},[s._v("# @enq.enqueue_jobs")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])])},function(){var s=this.$createElement,t=this._self._c||s;return t("p",[this._v("Poller拉取器 拉取 "),t("code",[this._v("retry：重试")]),this._v(" 跟"),t("code",[this._v("schedule：延时")]),this._v("集合的任务推入相关队列。默认是使用"),t("code",[this._v("Sidekiq::Scheduled::Enq")]),this._v("策略，每次使用一个时间作为score，在集合中获取匹配的第一个元素推入相关队列。\n可以自行修改推入队列的方式。")])},function(){var s=this.$createElement,t=this._self._c||s;return t("ul",[t("li",[this._v("Processor获取任务的策略")])])},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("div",{staticClass:"language-ruby line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-ruby"}},[a("code",[a("span",{attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),a("span",{attrs:{class:"token class-name"}},[s._v("Processor")]),s._v("\n  "),a("span",{attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),a("span",{attrs:{class:"token function"}},[s._v("initialize")]),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("mgr"),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n    "),a("span",{attrs:{class:"token variable"}},[s._v("@strategy")]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("mgr"),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("options"),a("span",{attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{attrs:{class:"token symbol"}},[s._v(":fetch")]),a("span",{attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v("||")]),s._v(" "),a("span",{attrs:{class:"token constant"}},[s._v("Sidekiq")]),a("span",{attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{attrs:{class:"token constant"}},[s._v("BasicFetch")]),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{attrs:{class:"token keyword"}},[s._v("new")]),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("mgr"),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("options"),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),a("span",{attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n"),a("span",{attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n\n"),a("span",{attrs:{class:"token comment"}},[s._v("# work = @strategy.retrieve_work")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])])},function(){var s=this.$createElement,t=this._self._c||s;return t("p",[this._v("每个Processor取出一个任务时，通过"),t("code",[this._v("@strategy = (mgr.options[:fetch] || Sidekiq::BasicFetch).new(mgr.options)")]),this._v(" 这个策略来获取，优先级的处理就是在这块处理的。\n如果不传入新的获取任务策略，则使用"),t("code",[this._v("Sidekiq::BasicFetch")]),this._v("当做默认策略。")])},function(){var s=this.$createElement,t=this._self._c||s;return t("h3",{attrs:{id:"权重-——-优先级"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#权重-——-优先级","aria-hidden":"true"}},[this._v("#")]),this._v(" 权重 —— 优先级")])},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("div",{staticClass:"language-ruby line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-ruby"}},[a("code",[a("span",{attrs:{class:"token comment"}},[s._v("# 格式 => sidekiq -q 队列名,权重")]),s._v("\nsidekiq "),a("span",{attrs:{class:"token operator"}},[s._v("-")]),s._v("q critical"),a("span",{attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{attrs:{class:"token number"}},[s._v("2")]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v("-")]),s._v("q default\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])])},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("div",{staticClass:"language-ruby line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-ruby"}},[a("code",[a("span",{attrs:{class:"token comment"}},[s._v("# sidekiq.yml")]),s._v("\n\n"),a("span",{attrs:{class:"token symbol"}},[s._v(":queues")]),a("span",{attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{attrs:{class:"token operator"}},[s._v("-")]),s._v(" "),a("span",{attrs:{class:"token punctuation"}},[s._v("[")]),s._v("critical"),a("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{attrs:{class:"token number"}},[s._v("2")]),a("span",{attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n  "),a("span",{attrs:{class:"token operator"}},[s._v("-")]),s._v(" default\n\n"),a("span",{attrs:{class:"token comment"}},[s._v("# 启动")]),s._v("\nsidekiq "),a("span",{attrs:{class:"token operator"}},[s._v("-")]),a("span",{attrs:{class:"token constant"}},[s._v("C")]),s._v(" sidekiq"),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yml\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])])},function(){var s=this.$createElement,t=this._self._c||s;return t("blockquote",[t("p",[this._v("Note：只要有一个队列配置了权重，那么整个sidekiq处理任务的时候，将不再按照队列声明的顺序来执行。")])])},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("div",{staticClass:"language-ruby line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-ruby"}},[a("code",[s._v("sidekiq "),a("span",{attrs:{class:"token operator"}},[s._v("-")]),s._v("q critical "),a("span",{attrs:{class:"token operator"}},[s._v("-")]),s._v("q default "),a("span",{attrs:{class:"token operator"}},[s._v("-")]),s._v("q low\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])])},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("div",{staticClass:"language-ruby line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-ruby"}},[a("code",[s._v("sidekiq "),a("span",{attrs:{class:"token operator"}},[s._v("-")]),s._v("q critical"),a("span",{attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v("-")]),s._v("q default"),a("span",{attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v("-")]),s._v("q low"),a("span",{attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{attrs:{class:"token number"}},[s._v("1")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])])},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("div",{staticClass:"language-ruby line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-ruby"}},[a("code",[a("span",{attrs:{class:"token comment"}},[s._v("# cli.rb")]),s._v("\n"),a("span",{attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),a("span",{attrs:{class:"token function"}},[s._v("parse_queue")]),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("opts"),a("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" q"),a("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" weight"),a("span",{attrs:{class:"token operator"}},[s._v("=")]),a("span",{attrs:{class:"token keyword"}},[s._v("nil")]),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),a("span",{attrs:{class:"token punctuation"}},[s._v("[")]),s._v("weight"),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("to_i"),a("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{attrs:{class:"token number"}},[s._v("1")]),a("span",{attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("max"),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("times "),a("span",{attrs:{class:"token keyword"}},[s._v("do")]),s._v("\n    "),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("opts"),a("span",{attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{attrs:{class:"token symbol"}},[s._v(":queues")]),a("span",{attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v("||")]),a("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v("<")]),a("span",{attrs:{class:"token operator"}},[s._v("<")]),s._v(" q\n  "),a("span",{attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n  opts"),a("span",{attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{attrs:{class:"token symbol"}},[s._v(":strict")]),a("span",{attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{attrs:{class:"token keyword"}},[s._v("false")]),s._v(" "),a("span",{attrs:{class:"token keyword"}},[s._v("if")]),s._v(" weight"),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("to_i "),a("span",{attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{attrs:{class:"token number"}},[s._v("0")]),s._v("\n"),a("span",{attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])])},function(){var s=this.$createElement,t=this._self._c||s;return t("ul",[t("li",[this._v("opts[:queues]\n根据权重构造queue_name数组。")])])},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("div",{staticClass:"language-ruby line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-ruby"}},[a("code",[s._v("sidekiq "),a("span",{attrs:{class:"token operator"}},[s._v("-")]),s._v("q critical"),a("span",{attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{attrs:{class:"token number"}},[s._v("3")]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v("-")]),s._v("q default"),a("span",{attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{attrs:{class:"token number"}},[s._v("2")]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v("-")]),s._v("q low"),a("span",{attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{attrs:{class:"token number"}},[s._v("1")]),s._v("\n\nopts"),a("span",{attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{attrs:{class:"token symbol"}},[s._v(":queues")]),a("span",{attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v("=")]),a("span",{attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{attrs:{class:"token punctuation"}},[s._v("[")]),s._v("critical"),a("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" critical"),a("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" critical"),a("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" default"),a("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" default"),a("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" low"),a("span",{attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])])},function(){var s=this.$createElement,t=this._self._c||s;return t("ul",[t("li",[this._v("opts[:strict]\n队列是否按顺序。\n如果其中有一个队列有权重配置，则 "),t("code",[this._v("opts[:strict] = false")])])])},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("div",{staticClass:"language-ruby line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-ruby"}},[a("code",[a("span",{attrs:{class:"token comment"}},[s._v("# fetch.rb")]),s._v("\n"),a("span",{attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),a("span",{attrs:{class:"token class-name"}},[s._v("BasicFetch")]),s._v("\n  "),a("span",{attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),a("span",{attrs:{class:"token function"}},[s._v("initialize")]),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("options"),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),a("span",{attrs:{class:"token variable"}},[s._v("@strictly_ordered_queues")]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v("!")]),a("span",{attrs:{class:"token operator"}},[s._v("!")]),s._v("options"),a("span",{attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{attrs:{class:"token symbol"}},[s._v(":strict")]),a("span",{attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    "),a("span",{attrs:{class:"token variable"}},[s._v("@queues")]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" options"),a("span",{attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{attrs:{class:"token symbol"}},[s._v(":queues")]),a("span",{attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("map "),a("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v("|")]),s._v("q"),a("span",{attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{attrs:{class:"token string"}},[s._v('"queue:'),a("span",{attrs:{class:"token interpolation"}},[a("span",{attrs:{class:"token delimiter tag"}},[s._v("#{")]),s._v("q"),a("span",{attrs:{class:"token delimiter tag"}},[s._v("}")])]),s._v('"')]),s._v(" "),a("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),a("span",{attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{attrs:{class:"token variable"}},[s._v("@strictly_ordered_queues")]),s._v("\n      "),a("span",{attrs:{class:"token variable"}},[s._v("@queues")]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{attrs:{class:"token variable"}},[s._v("@queues")]),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("uniq\n      "),a("span",{attrs:{class:"token variable"}},[s._v("@queues")]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v("<")]),a("span",{attrs:{class:"token operator"}},[s._v("<")]),s._v(" "),a("span",{attrs:{class:"token constant"}},[s._v("TIMEOUT")]),s._v("\n    "),a("span",{attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n  "),a("span",{attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n\n  "),a("span",{attrs:{class:"token keyword"}},[s._v("def")]),s._v(" retrieve_work\n    work "),a("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{attrs:{class:"token constant"}},[s._v("Sidekiq")]),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("redis "),a("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v("|")]),s._v("conn"),a("span",{attrs:{class:"token operator"}},[s._v("|")]),s._v(" conn"),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{attrs:{class:"token function"}},[s._v("brpop")]),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{attrs:{class:"token operator"}},[s._v("*")]),s._v("queues_cmd"),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),a("span",{attrs:{class:"token constant"}},[s._v("UnitOfWork")]),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{attrs:{class:"token keyword"}},[s._v("new")]),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{attrs:{class:"token operator"}},[s._v("*")]),s._v("work"),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{attrs:{class:"token keyword"}},[s._v("if")]),s._v(" work\n  "),a("span",{attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n\n  "),a("span",{attrs:{class:"token comment"}},[s._v("# Creating the Redis#brpop command takes into account any")]),s._v("\n  "),a("span",{attrs:{class:"token comment"}},[s._v("# configured queue weights. By default Redis#brpop returns")]),s._v("\n  "),a("span",{attrs:{class:"token comment"}},[s._v("# data from the first queue that has pending elements. We")]),s._v("\n  "),a("span",{attrs:{class:"token comment"}},[s._v("# recreate the queue command each time we invoke Redis#brpop")]),s._v("\n  "),a("span",{attrs:{class:"token comment"}},[s._v("# to honor weights and avoid queue starvation.")]),s._v("\n  "),a("span",{attrs:{class:"token keyword"}},[s._v("def")]),s._v(" queues_cmd\n    "),a("span",{attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{attrs:{class:"token variable"}},[s._v("@strictly_ordered_queues")]),s._v("\n      "),a("span",{attrs:{class:"token variable"}},[s._v("@queues")]),s._v("\n    "),a("span",{attrs:{class:"token keyword"}},[s._v("else")]),s._v("\n      queues "),a("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{attrs:{class:"token variable"}},[s._v("@queues")]),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("shuffle"),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("uniq\n      queues "),a("span",{attrs:{class:"token operator"}},[s._v("<")]),a("span",{attrs:{class:"token operator"}},[s._v("<")]),s._v(" "),a("span",{attrs:{class:"token constant"}},[s._v("TIMEOUT")]),s._v("\n      queues\n    "),a("span",{attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n  "),a("span",{attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n"),a("span",{attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br")])])},function(){var s=this.$createElement,t=this._self._c||s;return t("blockquote",[t("p",[this._v("queues = @queues.shuffle.uniq\n权重大的，排在前面的概率大，率先执行的概率也就大。")])])},function(){var s=this.$createElement,t=this._self._c||s;return t("p",[this._v("然后配合redis的"),t("code",[this._v("brpop")]),this._v("：")])},function(){var s=this.$createElement,t=this._self._c||s;return t("blockquote",[t("p",[this._v("redis.brpop(queue1, queue2, time_out)\n可以给定一组列表 queue_a， queue_b， queue_c，在加上一个超时时间。\n会依次检查列表，直到找到一个元素 或者 超时 或者 一直阻塞着（没有设置超时时间）。")]),this._v(" "),t("p",[this._v("sidekiq配合Redis 使用起来十分方便。")])])},function(){var s=this.$createElement,t=this._self._c||s;return t("h3",{attrs:{id:"中间件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#中间件","aria-hidden":"true"}},[this._v("#")]),this._v(" 中间件")])},function(){var s=this.$createElement,t=this._self._c||s;return t("p",[this._v("客户端推进一个任务时，会经过一些参数格式化（如生成对应的入队列格式，添加任务的自定义id等 ）。\nsidekiq允许自定义一些入队列前的操作，通过中间件来实现。比如："),t("code",[this._v("添加入队列前的参数")]),this._v(" 或者 "),t("code",[this._v("根据条件，过滤掉任务，阻止任务入队列")]),this._v(" 等等。")])},function(){var s=this.$createElement,t=this._self._c||s;return t("ul",[t("li",[this._v("全局的：直接Sidekiq的config添加。")])])},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("div",{staticClass:"language-ruby line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-ruby"}},[a("code",[a("span",{attrs:{class:"token constant"}},[s._v("Sidekiq")]),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("configure_server "),a("span",{attrs:{class:"token keyword"}},[s._v("do")]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v("|")]),s._v("config"),a("span",{attrs:{class:"token operator"}},[s._v("|")]),s._v("\n  config"),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("client_middleware "),a("span",{attrs:{class:"token keyword"}},[s._v("do")]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v("|")]),s._v("chain"),a("span",{attrs:{class:"token operator"}},[s._v("|")]),s._v("\n    chain"),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("add "),a("span",{attrs:{class:"token constant"}},[s._v("MyClientMiddleware")]),s._v("\n  "),a("span",{attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n"),a("span",{attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])])},function(){var s=this.$createElement,t=this._self._c||s;return t("ul",[t("li",[this._v("局部的：针对当个client添加。")])])},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("div",{staticClass:"language-ruby line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-ruby"}},[a("code",[s._v("client "),a("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{attrs:{class:"token constant"}},[s._v("Sidekiq")]),a("span",{attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{attrs:{class:"token constant"}},[s._v("Client")]),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{attrs:{class:"token keyword"}},[s._v("new")]),s._v("\n"),a("span",{attrs:{class:"token class-name"}},[s._v("client"),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("middleware")]),s._v(" "),a("span",{attrs:{class:"token keyword"}},[s._v("do")]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v("|")]),s._v("chain"),a("span",{attrs:{class:"token operator"}},[s._v("|")]),s._v("\n  chain"),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("use "),a("span",{attrs:{class:"token constant"}},[s._v("MyClientMiddleware")]),s._v("\n"),a("span",{attrs:{class:"token keyword"}},[s._v("end")]),s._v("\nclient"),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{attrs:{class:"token function"}},[s._v("push")]),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{attrs:{class:"token string"}},[s._v("'class'")]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v("=")]),a("span",{attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{attrs:{class:"token string"}},[s._v("'SomeWorker'")]),a("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{attrs:{class:"token string"}},[s._v("'args'")]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v("=")]),a("span",{attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{attrs:{class:"token number"}},[s._v("1")]),a("span",{attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{attrs:{class:"token number"}},[s._v("2")]),a("span",{attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{attrs:{class:"token number"}},[s._v("3")]),a("span",{attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])])},function(){var s=this.$createElement,t=this._self._c||s;return t("p",[this._v("每个client走过的中间件是 "),t("code",[this._v("全局的 + 局部的")]),this._v("。")])},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("div",{staticClass:"language-ruby line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-ruby"}},[a("code",[a("span",{attrs:{class:"token comment"}},[s._v("# client.rb")]),s._v("\n"),a("span",{attrs:{class:"token keyword"}},[s._v("module")]),s._v(" "),a("span",{attrs:{class:"token constant"}},[s._v("Sidekiq")]),s._v("\n  "),a("span",{attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),a("span",{attrs:{class:"token class-name"}},[s._v("Client")]),s._v("\n    "),a("span",{attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),a("span",{attrs:{class:"token function"}},[s._v("middleware")]),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{attrs:{class:"token operator"}},[s._v("&")]),s._v("block"),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n      "),a("span",{attrs:{class:"token variable"}},[s._v("@chain")]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v("||")]),a("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{attrs:{class:"token constant"}},[s._v("Sidekiq")]),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("client_middleware "),a("span",{attrs:{class:"token comment"}},[s._v("# 先将全局的加进来~")]),s._v("\n      "),a("span",{attrs:{class:"token keyword"}},[s._v("if")]),s._v(" block_given"),a("span",{attrs:{class:"token operator"}},[s._v("?")]),s._v(" "),a("span",{attrs:{class:"token comment"}},[s._v("# 这里添加局部中间件的处理")]),s._v("\n        "),a("span",{attrs:{class:"token variable"}},[s._v("@chain")]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{attrs:{class:"token variable"}},[s._v("@chain")]),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("dup\n        "),a("span",{attrs:{class:"token keyword"}},[s._v("yield")]),s._v(" "),a("span",{attrs:{class:"token variable"}},[s._v("@chain")]),s._v("\n      "),a("span",{attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n      "),a("span",{attrs:{class:"token variable"}},[s._v("@chain")]),s._v(" "),a("span",{attrs:{class:"token comment"}},[s._v("# chain存了该client相关的中间件")]),s._v("\n    "),a("span",{attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n  "),a("span",{attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n"),a("span",{attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])])},function(){var s=this.$createElement,t=this._self._c||s;return t("p",[this._v("创建一个"),t("code",[this._v("Client实例")]),this._v("时，该"),t("code",[this._v("client")]),this._v("已经将所有需要的中间件存在一个chain里面等待调用。\n而执行中间件的调用时，通过一个精简的递归就将所有中间件执行。")])},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("div",{staticClass:"language-ruby line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-ruby"}},[a("code",[a("span",{attrs:{class:"token comment"}},[s._v("# client.rb")]),s._v("\nmiddleware"),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{attrs:{class:"token function"}},[s._v("invoke")]),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("worker_class"),a("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" item"),a("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" queue"),a("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{attrs:{class:"token variable"}},[s._v("@redis_pool")]),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{attrs:{class:"token keyword"}},[s._v("do")]),s._v("\n  item\n"),a("span",{attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])])},function(){var s=this.$createElement,t=this._self._c||s;return t("p",[this._v("client.middleware返回一个chain。"),t("code",[this._v("chain.invoke")]),this._v("定义如下：")])},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("div",{staticClass:"language-ruby line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-ruby"}},[a("code",[a("span",{attrs:{class:"token comment"}},[s._v("# chain.rb")]),s._v("\n"),a("span",{attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),a("span",{attrs:{class:"token function"}},[s._v("invoke")]),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{attrs:{class:"token operator"}},[s._v("*")]),s._v("args"),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  chain "),a("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" retrieve"),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("dup\n  traverse_chain "),a("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" lambda "),a("span",{attrs:{class:"token keyword"}},[s._v("do")]),s._v("\n    "),a("span",{attrs:{class:"token keyword"}},[s._v("if")]),s._v(" chain"),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("empty"),a("span",{attrs:{class:"token operator"}},[s._v("?")]),s._v("\n      "),a("span",{attrs:{class:"token keyword"}},[s._v("yield")]),s._v("\n    "),a("span",{attrs:{class:"token keyword"}},[s._v("else")]),s._v("\n      chain"),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("shift"),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{attrs:{class:"token function"}},[s._v("call")]),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{attrs:{class:"token operator"}},[s._v("*")]),s._v("args"),a("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v("&")]),s._v("traverse_chain"),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{attrs:{class:"token comment"}},[s._v("# 每次弹出最前的middleware并进行递归，这样中间件一层一层嵌套")]),s._v("\n    "),a("span",{attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n  "),a("span",{attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n  traverse_chain"),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("call "),a("span",{attrs:{class:"token comment"}},[s._v("# 执行")]),s._v("\n"),a("span",{attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])])},function(){var s=this.$createElement,t=this._self._c||s;return t("blockquote",[t("p",[this._v("NOTE-1：既然都给 lambda命名了，为啥不使用def 定义呢？\n我想是直接使用闭包，不用将剩余的chain暴露出来。")])])},function(){var s=this.$createElement,t=this._self._c||s;return t("ul",[t("li",[this._v("能够响应call")]),this._v(" "),t("li",[this._v("接收特定的参数供层级传递")])])},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("div",{staticClass:"language-ruby line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-ruby"}},[a("code",[a("span",{attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),a("span",{attrs:{class:"token class-name"}},[s._v("MyClientMiddleware")]),s._v("\n  "),a("span",{attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),a("span",{attrs:{class:"token function"}},[s._v("call")]),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("worker_class"),a("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" job"),a("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" queue"),a("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" redis_pool"),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),a("span",{attrs:{class:"token comment"}},[s._v("# return false/nil to stop the job from going to redis")]),s._v("\n    "),a("span",{attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),a("span",{attrs:{class:"token keyword"}},[s._v("false")]),s._v(" "),a("span",{attrs:{class:"token keyword"}},[s._v("if")]),s._v(" queue "),a("span",{attrs:{class:"token operator"}},[s._v("!=")]),s._v(" "),a("span",{attrs:{class:"token string"}},[s._v("'default'")]),s._v("\n    job"),a("span",{attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{attrs:{class:"token string"}},[s._v("'customer'")]),a("span",{attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{attrs:{class:"token constant"}},[s._v("Customer")]),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("current_id\n    "),a("span",{attrs:{class:"token keyword"}},[s._v("yield")]),s._v("\n  "),a("span",{attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n"),a("span",{attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])])},function(){var s=this.$createElement,t=this._self._c||s;return t("blockquote",[t("p",[this._v("NOTE-2：中间件的yield位置很重要，最好位于最后当做返回值。\n另外提前return可以阻止继续往下层传递，提交跳出chain。")])])},function(){var s=this.$createElement,t=this._self._c||s;return t("h3",{attrs:{id:"时间间隔的利用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#时间间隔的利用","aria-hidden":"true"}},[this._v("#")]),this._v(" 时间间隔的利用")])},function(){var s=this.$createElement,t=this._self._c||s;return t("p",[this._v("每个sidekiq进程启动时，会启动相关的Poller，"),t("code",[this._v("initial_wait")]),this._v("加入一个随机时间避免或减少同时请求IO。")])},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("div",{staticClass:"language-ruby line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-ruby"}},[a("code",[a("span",{attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),a("span",{attrs:{class:"token class-name"}},[s._v("Poller")]),s._v("\n  "),a("span",{attrs:{class:"token keyword"}},[s._v("def")]),s._v(" start\n    "),a("span",{attrs:{class:"token variable"}},[s._v("@thread")]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v("||")]),a("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{attrs:{class:"token function"}},[s._v("safe_thread")]),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{attrs:{class:"token string"}},[s._v('"scheduler"')]),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{attrs:{class:"token keyword"}},[s._v("do")]),s._v("\n      initial_wait   "),a("span",{attrs:{class:"token comment"}},[s._v("# ==> here")]),s._v("\n\n      "),a("span",{attrs:{class:"token keyword"}},[s._v("while")]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v("!")]),a("span",{attrs:{class:"token variable"}},[s._v("@done")]),s._v("\n        enqueue\n        wait       "),a("span",{attrs:{class:"token comment"}},[s._v("# ==> here")]),s._v("\n      "),a("span",{attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n      "),a("span",{attrs:{class:"token constant"}},[s._v("Sidekiq")]),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("logger"),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{attrs:{class:"token function"}},[s._v("info")]),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{attrs:{class:"token string"}},[s._v('"Scheduler exiting..."')]),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),a("span",{attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n  "),a("span",{attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n\n  "),a("span",{attrs:{class:"token keyword"}},[s._v("def")]),s._v(" initial_wait\n    "),a("span",{attrs:{class:"token comment"}},[s._v("# Have all processes sleep between 5-15 seconds.  10 seconds")]),s._v("\n    "),a("span",{attrs:{class:"token comment"}},[s._v("# to give time for the heartbeat to register (if the poll interval is going to be calculated by the number")]),s._v("\n    "),a("span",{attrs:{class:"token comment"}},[s._v("# of workers), and 5 random seconds to ensure they don't all hit Redis at the same time.")]),s._v("\n    total "),a("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{attrs:{class:"token number"}},[s._v("0")]),s._v("\n    total "),a("span",{attrs:{class:"token operator"}},[s._v("+")]),a("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{attrs:{class:"token constant"}},[s._v("INITIAL_WAIT")]),s._v(" "),a("span",{attrs:{class:"token keyword"}},[s._v("unless")]),s._v(" "),a("span",{attrs:{class:"token constant"}},[s._v("Sidekiq")]),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("options"),a("span",{attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{attrs:{class:"token symbol"}},[s._v(":poll_interval_average")]),a("span",{attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    total "),a("span",{attrs:{class:"token operator"}},[s._v("+")]),a("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{attrs:{class:"token number"}},[s._v("5")]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v("*")]),s._v(" rand"),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n    "),a("span",{attrs:{class:"token variable"}},[s._v("@sleeper")]),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{attrs:{class:"token function"}},[s._v("pop")]),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("total"),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),a("span",{attrs:{class:"token keyword"}},[s._v("rescue")]),s._v(" "),a("span",{attrs:{class:"token constant"}},[s._v("Timeout")]),a("span",{attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{attrs:{class:"token constant"}},[s._v("Error")]),s._v("\n  "),a("span",{attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n"),a("span",{attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br")])])},function(){var s=this.$createElement,t=this._self._c||s;return t("p",[this._v("在拉取"),t("code",[this._v("retry：重试")]),this._v(" 跟"),t("code",[this._v("schedule：延时")]),this._v("集合的一个任务推入队列之后，就\n休眠一段时间。而这时间不是固定的。")])},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("div",{staticClass:"language-ruby line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-ruby"}},[a("code",[a("span",{attrs:{class:"token keyword"}},[s._v("def")]),s._v(" wait\n   "),a("span",{attrs:{class:"token variable"}},[s._v("@sleeper")]),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{attrs:{class:"token function"}},[s._v("pop")]),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("random_poll_interval"),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),a("span",{attrs:{class:"token keyword"}},[s._v("rescue")]),s._v(" "),a("span",{attrs:{class:"token constant"}},[s._v("Timeout")]),a("span",{attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{attrs:{class:"token constant"}},[s._v("Error")]),s._v("\n    "),a("span",{attrs:{class:"token comment"}},[s._v("# expected")]),s._v("\n  "),a("span",{attrs:{class:"token keyword"}},[s._v("rescue")]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v("=")]),a("span",{attrs:{class:"token operator"}},[s._v(">")]),s._v(" ex\n    "),a("span",{attrs:{class:"token comment"}},[s._v("# if poll_interval_average hasn't been calculated yet, we can")]),s._v("\n    "),a("span",{attrs:{class:"token comment"}},[s._v("# raise an error trying to reach Redis.")]),s._v("\n    logger"),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("error ex"),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("message\n    "),a("span",{attrs:{class:"token function"}},[s._v("handle_exception")]),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ex"),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    sleep "),a("span",{attrs:{class:"token number"}},[s._v("5")]),s._v("\n  "),a("span",{attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n"),a("span",{attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])])},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("div",{staticClass:"language-ruby line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-ruby"}},[a("code",[a("span",{attrs:{class:"token comment"}},[s._v("# Calculates a random interval that is ±50% the desired average.")]),s._v("\n"),a("span",{attrs:{class:"token keyword"}},[s._v("def")]),s._v(" random_poll_interval\n  poll_interval_average "),a("span",{attrs:{class:"token operator"}},[s._v("*")]),s._v(" rand "),a("span",{attrs:{class:"token operator"}},[s._v("+")]),s._v(" poll_interval_average"),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("to_f "),a("span",{attrs:{class:"token operator"}},[s._v("/")]),s._v(" "),a("span",{attrs:{class:"token number"}},[s._v("2")]),s._v("\n"),a("span",{attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])])},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("div",{staticClass:"language-ruby line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-ruby"}},[a("code",[a("span",{attrs:{class:"token comment"}},[s._v("# We do our best to tune the poll interval to the size of the active Sidekiq")]),s._v("\n"),a("span",{attrs:{class:"token comment"}},[s._v("# cluster.  If you have 30 processes and poll every 15 seconds, that means one")]),s._v("\n"),a("span",{attrs:{class:"token comment"}},[s._v("# Sidekiq is checking Redis every 0.5 seconds - way too often for most people")]),s._v("\n"),a("span",{attrs:{class:"token comment"}},[s._v("# and really bad if the retry or scheduled sets are large.")]),s._v("\n"),a("span",{attrs:{class:"token comment"}},[s._v("#")]),s._v("\n"),a("span",{attrs:{class:"token comment"}},[s._v("# Instead try to avoid polling more than once every 15 seconds.  If you have")]),s._v("\n"),a("span",{attrs:{class:"token comment"}},[s._v("# 30 Sidekiq processes, we'll poll every 30 * 15 or 450 seconds.")]),s._v("\n"),a("span",{attrs:{class:"token comment"}},[s._v("# To keep things statistically random, we will sleep a random amount between")]),s._v("\n"),a("span",{attrs:{class:"token comment"}},[s._v("# 225 and 675 seconds for each poll or 450 seconds on average.  Otherwise restarting")]),s._v("\n"),a("span",{attrs:{class:"token comment"}},[s._v("# all your Sidekiq processes at the same time will lead to them all polling at")]),s._v("\n"),a("span",{attrs:{class:"token comment"}},[s._v("# the same time: the thundering herd problem.")]),s._v("\n"),a("span",{attrs:{class:"token comment"}},[s._v("#")]),s._v("\n"),a("span",{attrs:{class:"token comment"}},[s._v("# We only do this if poll_interval_average is unset (the default).")]),s._v("\n"),a("span",{attrs:{class:"token keyword"}},[s._v("def")]),s._v(" poll_interval_average\n  "),a("span",{attrs:{class:"token constant"}},[s._v("Sidekiq")]),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("options"),a("span",{attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{attrs:{class:"token symbol"}},[s._v(":poll_interval_average")]),a("span",{attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v("||")]),a("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" scaled_poll_interval\n"),a("span",{attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br")])])},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("div",{staticClass:"language-ruby line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-ruby"}},[a("code",[a("span",{attrs:{class:"token comment"}},[s._v("# Calculates an average poll interval based on the number of known Sidekiq processes.")]),s._v("\n"),a("span",{attrs:{class:"token comment"}},[s._v("# This minimizes a single point of failure by dispersing check-ins but without taxing")]),s._v("\n"),a("span",{attrs:{class:"token comment"}},[s._v("# Redis if you run many Sidekiq processes.")]),s._v("\n"),a("span",{attrs:{class:"token keyword"}},[s._v("def")]),s._v(" scaled_poll_interval\n  pcount "),a("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{attrs:{class:"token constant"}},[s._v("Sidekiq")]),a("span",{attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{attrs:{class:"token constant"}},[s._v("ProcessSet")]),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{attrs:{class:"token keyword"}},[s._v("new")]),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("size\n  pcount "),a("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{attrs:{class:"token keyword"}},[s._v("if")]),s._v(" pcount "),a("span",{attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),a("span",{attrs:{class:"token number"}},[s._v("0")]),s._v("\n  pcount "),a("span",{attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{attrs:{class:"token constant"}},[s._v("Sidekiq")]),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("options"),a("span",{attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{attrs:{class:"token symbol"}},[s._v(":average_scheduled_poll_interval")]),a("span",{attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])])},function(){var s=this.$createElement,t=this._self._c||s;return t("h3",{attrs:{id:"其它点"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#其它点","aria-hidden":"true"}},[this._v("#")]),this._v(" 其它点")])},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ul",[a("li",[s._v("Redis各种数据结构在sidekiq的使用")]),s._v(" "),a("li",[s._v("任务如何重试")]),s._v(" "),a("li",[s._v("当任务处理一半收到停止信号如何处理")]),s._v(" "),a("li",[s._v("一个Processor挂了之后如何处理")]),s._v(" "),a("li",[s._v("队列堆积怎么处理")]),s._v(" "),a("li",[s._v("……")])])},function(){var s=this.$createElement,t=this._self._c||s;return t("h2",{attrs:{id:"参考文档"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#参考文档","aria-hidden":"true"}},[this._v("#")]),this._v(" 参考文档")])}],!1,null,null,null);e.options.__file="sidekiq.md";t.default=e.exports}}]);