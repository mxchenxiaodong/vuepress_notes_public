<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Python装饰器 与 Ruby实现 | ......</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/vuepress_notes_public/assets/css/0.styles.3d6faa3b.css" as="style"><link rel="preload" href="/vuepress_notes_public/assets/js/app.2153f277.js" as="script"><link rel="preload" href="/vuepress_notes_public/assets/js/12.50959c55.js" as="script"><link rel="prefetch" href="/vuepress_notes_public/assets/js/10.db4bf83d.js"><link rel="prefetch" href="/vuepress_notes_public/assets/js/11.4160b921.js"><link rel="prefetch" href="/vuepress_notes_public/assets/js/13.22af0d65.js"><link rel="prefetch" href="/vuepress_notes_public/assets/js/14.1d014915.js"><link rel="prefetch" href="/vuepress_notes_public/assets/js/2.fe74a032.js"><link rel="prefetch" href="/vuepress_notes_public/assets/js/3.41252eed.js"><link rel="prefetch" href="/vuepress_notes_public/assets/js/4.6945ad37.js"><link rel="prefetch" href="/vuepress_notes_public/assets/js/5.5636cd22.js"><link rel="prefetch" href="/vuepress_notes_public/assets/js/6.cf4a0e04.js"><link rel="prefetch" href="/vuepress_notes_public/assets/js/7.c6ef01d7.js"><link rel="prefetch" href="/vuepress_notes_public/assets/js/8.e2170d55.js"><link rel="prefetch" href="/vuepress_notes_public/assets/js/9.528204ac.js">
    <link rel="stylesheet" href="/vuepress_notes_public/assets/css/0.styles.3d6faa3b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/vuepress_notes_public/" class="home-link router-link-active"><!----> <span class="site-name">......</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/vuepress_notes_public/" class="nav-link">Home</a></div><div class="nav-item"><a href="https://vuepress.vuejs.org/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  VuePress
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/vuepress_notes_public/" class="nav-link">Home</a></div><div class="nav-item"><a href="https://vuepress.vuejs.org/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  VuePress
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading"><span>js</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>ruby</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/vuepress_notes_public/ruby/sidekiq.html" class="sidebar-link">分享之sidekiq</a></li><li><a href="/vuepress_notes_public/ruby/ruby_decorator.html" class="active sidebar-link">Python装饰器 与 Ruby实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuepress_notes_public/ruby/ruby_decorator.html#python中的装饰器" class="sidebar-link">Python中的装饰器</a></li><li class="sidebar-sub-header"><a href="/vuepress_notes_public/ruby/ruby_decorator.html#ruby实现python中类似的装饰器" class="sidebar-link">Ruby实现Python中类似的装饰器</a></li><li class="sidebar-sub-header"><a href="/vuepress_notes_public/ruby/ruby_decorator.html#参考文档" class="sidebar-link">参考文档</a></li></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="python装饰器-与-ruby实现"><a href="#python装饰器-与-ruby实现" aria-hidden="true" class="header-anchor">#</a> Python装饰器 与 Ruby实现</h1> <h2 id="python中的装饰器"><a href="#python中的装饰器" aria-hidden="true" class="header-anchor">#</a> Python中的装饰器</h2> <p>装饰器是Python中一个很重要的特性。有两个好处：</p> <ul><li>DRY</li> <li>组合更方便</li></ul> <p>创建了一个函数，然后想为其添加性能监控，计数，加日志等额外的功能，便可以使用装饰器（性能监控装饰器， 计数装饰器，加日志装饰器），而且，这些装饰器也可以供别的有需要的函数使用，且可以自由组合。</p> <p>关键点：</p> <ul><li>Python中函数也是一个<code>对象</code>。a_function_to_decorate是对象引用，a_function_to_decorate()是执行。</li> <li>装饰器本身也就一个函数而已。</li> <li>装饰器函数在脚本载入的时候就执行了，相当于对原有函数的重写。</li> <li>可以在函数中定义另一个函数，供使用或者返回，存在于函数内部。</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">my_shiny_new_decorator</span><span class="token punctuation">(</span>a_function_to_decorate<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Before the function runs&quot;</span><span class="token punctuation">)</span>
        a_function_to_decorate<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;After the function runs&quot;</span><span class="token punctuation">)</span>

	  <span class="token keyword">return</span> wrapper

@my_shiny_new_decorator
<span class="token keyword">def</span> <span class="token function">a_stand_alone_function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;I am a stand alone function, don't you dare modify me&quot;</span><span class="token punctuation">)</span>


<span class="token comment"># 相当于方法重写</span>
a_stand_alone_function <span class="token operator">=</span> my_shiny_new_decorator<span class="token punctuation">(</span>a_stand_alone_function<span class="token punctuation">)</span>
a_stand_alone_function<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># @只是Python添加的一个语法糖</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>NOTE:
上面只是简单装饰器，复杂一点的装饰器还可以接收参数。可以思考一下如何处理？</p> <hr> <h2 id="ruby实现python中类似的装饰器"><a href="#ruby实现python中类似的装饰器" aria-hidden="true" class="header-anchor">#</a> Ruby实现Python中类似的装饰器</h2> <h3 id="ruby与python的几个不同点"><a href="#ruby与python的几个不同点" aria-hidden="true" class="header-anchor">#</a> Ruby与Python的几个不同点</h3> <div class="language-ruby line-numbers-mode"><pre class="language-ruby"><code><span class="token keyword">class</span> <span class="token class-name">Person</span>
  <span class="token keyword">def</span> talk
    <span class="token keyword">def</span> hehe
      p <span class="token string">&quot;hehe...&quot;</span>
    <span class="token keyword">end</span>

    p <span class="token string">&quot;talking...&quot;</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>

person <span class="token operator">=</span> <span class="token constant">Person</span><span class="token punctuation">.</span><span class="token keyword">new</span>
<span class="token class-name">person<span class="token punctuation">.</span>talk</span>
person<span class="token punctuation">.</span><span class="token function">talk</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

person_b <span class="token operator">=</span> <span class="token constant">Person</span><span class="token punctuation">.</span><span class="token keyword">new</span>
<span class="token class-name">person_b<span class="token punctuation">.</span>hehe</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><ul><li>方法调用时，有没有括号是一样的。Ruby 中的methods并不是一个对象。</li> <li>定义了<code>hehe</code>，其实变成了实例方法，对于Person类的实例都可见。</li></ul> <h3 id="实现"><a href="#实现" aria-hidden="true" class="header-anchor">#</a> 实现</h3> <p>那么对于Ruby来讲，我该如何去实现Python类似的装饰器呢？</p> <p>实现的思路：</p> <ul><li>当加载一个脚本Ruby文件时，是一行一行执行，可以使用类宏的方式。</li> <li>本质上，添加装饰器，就是重写用户定义的methods。</li> <li>怎么做到自动重写？配合Ruby中一些钩子方法即可。</li></ul> <h4 id="使用-lambda-or-proc"><a href="#使用-lambda-or-proc" aria-hidden="true" class="header-anchor">#</a> 使用 lambda or Proc</h4> <p>一开始我想，我可以使用 <code>lambda or Proc</code> 来代替内部函数的定义， 并将其返回。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">my_shiny_new_decorator</span><span class="token punctuation">(</span>a_function_to_decorate<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Before the function runs&quot;</span><span class="token punctuation">)</span>
        a_function_to_decorate<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;After the function runs&quot;</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> wrapper
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>可以替换成：</p> <div class="language-ruby line-numbers-mode"><pre class="language-ruby"><code><span class="token keyword">def</span> <span class="token function">my_shiny_new_decorator</span><span class="token punctuation">(</span>a_function_to_decorate<span class="token punctuation">)</span>
  wrapper <span class="token operator">=</span> <span class="token builtin">Proc</span><span class="token punctuation">.</span><span class="token keyword">new</span> <span class="token class-name">do</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;Before the function runs&quot;</span><span class="token punctuation">)</span>
    <span class="token function">a_function_to_decorate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;After the function runs&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">end</span>

  <span class="token keyword">return</span> wrapper
<span class="token keyword">end</span>

<span class="token keyword">def</span> <span class="token function">a_stand_alone_function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">end</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>但是，这样一来，要调用方法的时候，得变成<code>a_stand_alone_function.call()</code> ，这样就改变了原有使用方法。不太好。</p> <h4 id="那就换种方式呗。"><a href="#那就换种方式呗。" aria-hidden="true" class="header-anchor">#</a> 那就换种方式呗。</h4> <p>在装饰器方法里，接收一个block，用来表示原始方法，大概的格式如下：</p> <div class="language-ruby line-numbers-mode"><pre class="language-ruby"><code><span class="token keyword">class</span> <span class="token class-name">Myclass</span>
  extend <span class="token constant">MyDecorator</span>

  <span class="token comment"># 这是装饰器</span>
  <span class="token keyword">def</span> my_shiny_new_decorator
    p <span class="token string">&quot;Before the function runs&quot;</span>
    <span class="token keyword">yield</span>
    p <span class="token string">&quot;After the function runs&quot;</span>
  <span class="token keyword">end</span>

  wrap <span class="token symbol">:my_shiny_new_decorator</span>
  <span class="token keyword">def</span> <span class="token function">a_stand_alone_function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 这是原始方法</span>
    p <span class="token string">&quot;I am a stand alone function, don't you dare modify me&quot;</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>现在的主要任务是如何实现 MyDecorator 模块的内容。</p> <ul><li><p><code>wrap :my_shiny_new_decorator</code>，Ruby脚本是按顺序执行的，这个类宏可以考虑使用一个栈的结构来实现，将<code>my_shiny_new_decorator</code>压进栈，再弹出，这样便可以保持顺序。</p></li> <li><p><code>使用define_methond</code>来重新定义方法，把原有方法嵌入装饰器方法中。</p></li></ul> <div class="language-ruby line-numbers-mode"><pre class="language-ruby"><code><span class="token keyword">module</span> <span class="token constant">MyDecorator</span>
  <span class="token comment"># 钩子方法</span>
  <span class="token keyword">def</span> <span class="token function">method_added</span><span class="token punctuation">(</span>method_name<span class="token punctuation">)</span>
    <span class="token keyword">unless</span> decorator_methods<span class="token punctuation">.</span>empty<span class="token operator">?</span>
      decorator_method <span class="token operator">=</span> decorator_methods<span class="token punctuation">.</span>pop

      <span class="token comment"># 使用alias_method生成一个别名指向。</span>
      new_method_name <span class="token operator">=</span> <span class="token string">&quot;<span class="token interpolation"><span class="token delimiter tag">#{</span>method_name<span class="token delimiter tag">}</span></span>_without_decorator&quot;</span>
      <span class="token function">alias_method</span><span class="token punctuation">(</span>new_method_name<span class="token punctuation">,</span> method_name<span class="token punctuation">)</span>

      <span class="token comment"># 重写原来的方法</span>
      <span class="token keyword">define_method</span><span class="token punctuation">(</span>method_name<span class="token punctuation">)</span> <span class="token keyword">do</span>
        <span class="token function">method</span><span class="token punctuation">(</span>decorator_method<span class="token punctuation">)</span><span class="token punctuation">.</span>call <span class="token keyword">do</span>
          <span class="token function">method</span><span class="token punctuation">(</span>new_method_name<span class="token punctuation">)</span><span class="token punctuation">.</span>call
        <span class="token keyword">end</span>
      <span class="token keyword">end</span>
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>

  <span class="token keyword">def</span> <span class="token function">wrap</span><span class="token punctuation">(</span>decorator<span class="token punctuation">)</span>
    <span class="token variable">@decorator_methods</span> <span class="token operator">&lt;</span><span class="token operator">&lt;</span> decorator
  <span class="token keyword">end</span>

  <span class="token comment"># 一个栈,用来存装饰方法</span>
  <span class="token keyword">def</span> decorator_methods
    <span class="token variable">@decorator_methods</span> <span class="token operator">||</span><span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token constant">Myclass</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">.</span>a_stand_alone_function
<span class="token comment"># &quot;Before the function runs&quot;</span>
<span class="token comment"># &quot;I am a stand alone function, don't you dare modify me&quot;</span>
<span class="token comment"># &quot;After the function runs&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><h4 id="python中，如何使装饰器可以接收参数？"><a href="#python中，如何使装饰器可以接收参数？" aria-hidden="true" class="header-anchor">#</a> Python中，如何使装饰器可以接收参数？</h4> <p>在上面说了：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>@my_shiny_new_decorator
<span class="token keyword">def</span> <span class="token function">a_stand_alone_function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span>

<span class="token comment"># 相当于方法重写</span>
a_stand_alone_function <span class="token operator">=</span> my_shiny_new_decorator<span class="token punctuation">(</span>a_stand_alone_function<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>需要实现的功能：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>@my_shiny_new_decorator<span class="token punctuation">(</span>decorator_args1<span class="token punctuation">,</span> decorator_args2<span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">a_stand_alone_function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;I am a stand alone function, don't you dare modify me&quot;</span><span class="token punctuation">)</span>

<span class="token comment"># 相当于</span>
a_stand_alone_function <span class="token operator">=</span> my_shiny_new_decorator<span class="token punctuation">(</span>decorator_args1<span class="token punctuation">,</span> decorator_args2<span class="token punctuation">)</span><span class="token punctuation">(</span>a_stand_alone_function<span class="token punctuation">)</span>

<span class="token comment"># 上面说明啥？</span>
说明my_shiny_new_decorator<span class="token punctuation">(</span>decorator_args1<span class="token punctuation">,</span> decorator_args2<span class="token punctuation">)</span>返回一个 `接收一个function作为参数的函数` <span class="token operator">=</span><span class="token operator">&gt;</span> 这不就是相当于原先的my_shiny_new_decorator？也就是说，需要新建一个函数，将原先my_shiny_new_decorator定为内部函数返回出来。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>下面我们通过修改一些命名，来更加清晰地说明：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>
<span class="token keyword">def</span> <span class="token function">decorator_maker_with_arguments</span><span class="token punctuation">(</span>decorator_args1<span class="token punctuation">,</span> decorator_args2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;args1....{}&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>decorator_args1<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;args2....{}&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>decorator_args2<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># 原先的装饰器变为内部函数了</span>
    <span class="token keyword">def</span> <span class="token function">my_shiny_new_decorator</span><span class="token punctuation">(</span>a_function_to_decorate<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Before the function runs&quot;</span><span class="token punctuation">)</span>
            a_function_to_decorate<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;After the function runs&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> wrapper

    <span class="token comment"># 返回内部函数</span>
    <span class="token keyword">return</span> my_shiny_new_decorator

@decorator_maker_with_arguments<span class="token punctuation">(</span><span class="token string">&quot;red&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;blue&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">a_stand_alone_function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;I am a stand alone function, don't you dare modify me&quot;</span><span class="token punctuation">)</span>

a_stand_alone_function<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># ouput</span>
<span class="token comment"># args1....red</span>
<span class="token comment"># args2....blue</span>
<span class="token comment"># Before the function runs</span>
<span class="token comment"># I am a stand alone function, don't you dare modify me</span>
<span class="token comment"># After the function runs</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h4 id="关于闭包"><a href="#关于闭包" aria-hidden="true" class="header-anchor">#</a> 关于闭包</h4> <p>无论是Python ，还是Ruby关于装饰器的实现，都涉及到一个很重要的基础，那就是<code>闭包</code>。</p> <p>什么叫做<code>闭包</code>?</p> <blockquote><p>简单来说，就是程序运行时，所带的一组相关绑定，可以穿越作用域。</p></blockquote> <h4 id="题外话："><a href="#题外话：" aria-hidden="true" class="header-anchor">#</a> 题外话：</h4> <ul><li>method(:my_method_name)，可以根据方法名获取到对应的方法来实现执行。</li></ul> <div class="language-ruby line-numbers-mode"><pre class="language-ruby"><code>ef <span class="token function">dd</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
  p a <span class="token operator">+</span> b
<span class="token keyword">end</span>

haha <span class="token operator">=</span> <span class="token function">method</span><span class="token punctuation">(</span><span class="token symbol">:dd</span><span class="token punctuation">)</span>
haha<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment"># 3</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="参考文档"><a href="#参考文档" aria-hidden="true" class="header-anchor">#</a> 参考文档</h2> <p>alias vs alias_method</p> <ul><li><a href="http://lazybios.com/2015/11/alias-vs-aliasmethod/" target="_blank" rel="noopener noreferrer">Rails: alias 与 alias_method 的区别<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <p>闭包:</p> <ul><li>[What is the difference between a block, a proc, and a lambda in ruby? - Build, Break, Learn.]</li></ul> <p>block:</p> <ul><li><a href="https://mixandgo.com/blog/mastering-ruby-blocks-in-less-than-5-minutes" target="_blank" rel="noopener noreferrer">Mastering ruby blocks in less than 5 minutes - Mix &amp; Go<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <p>method:</p> <ul><li><a href="https://www.jianshu.com/p/9b62743a22f7" target="_blank" rel="noopener noreferrer">Ruby中的method方法 - 简书<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <p>装饰器</p> <ul><li><a href="https://www.jianshu.com/p/4ad9111e71fc" target="_blank" rel="noopener noreferrer">Ruby 实现装饰器模式 - 简书<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://coolshell.cn/articles/11265.html" target="_blank" rel="noopener noreferrer">Python修饰器的函数式编程 | | 酷 壳 - CoolShell<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>
https://taizilongxu.gitbooks.io/stackoverflow-about-python/content/3/README.html</li></ul> <h3 id="github上一些类似的实现"><a href="#github上一些类似的实现" aria-hidden="true" class="header-anchor">#</a> GitHub上一些类似的实现</h3> <ul><li><a href="https://github.com/wycats/ruby_decorators/blob/master/decorators.rb" target="_blank" rel="noopener noreferrer">ruby_decorators/decorators.rb at master · wycats/ruby_decorators · GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> -- 这个是简单版</li> <li><a href="https://github.com/fredwu/ruby_decorators" target="_blank" rel="noopener noreferrer">GitHub - fredwu/ruby_decorators: Ruby method decorators inspired by Python.<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/michaelfairley/method_decorators" target="_blank" rel="noopener noreferrer">GitHub - michaelfairley/method_decorators: Python’s method decorators for Ruby<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> -- 这个较为完整的版本</li></ul></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/vuepress_notes_public/ruby/sidekiq.html" class="prev">
          分享之sidekiq
        </a></span> <!----></p></div> </div> <!----></div></div>
    <script src="/vuepress_notes_public/assets/js/12.50959c55.js" defer></script><script src="/vuepress_notes_public/assets/js/app.2153f277.js" defer></script>
  </body>
</html>
