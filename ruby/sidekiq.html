<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>分享之sidekiq | ......</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/vuepress_notes_public/assets/css/0.styles.3d6faa3b.css" as="style"><link rel="preload" href="/vuepress_notes_public/assets/js/app.2153f277.js" as="script"><link rel="preload" href="/vuepress_notes_public/assets/js/13.22af0d65.js" as="script"><link rel="prefetch" href="/vuepress_notes_public/assets/js/10.db4bf83d.js"><link rel="prefetch" href="/vuepress_notes_public/assets/js/11.4160b921.js"><link rel="prefetch" href="/vuepress_notes_public/assets/js/12.50959c55.js"><link rel="prefetch" href="/vuepress_notes_public/assets/js/14.1d014915.js"><link rel="prefetch" href="/vuepress_notes_public/assets/js/2.fe74a032.js"><link rel="prefetch" href="/vuepress_notes_public/assets/js/3.41252eed.js"><link rel="prefetch" href="/vuepress_notes_public/assets/js/4.6945ad37.js"><link rel="prefetch" href="/vuepress_notes_public/assets/js/5.5636cd22.js"><link rel="prefetch" href="/vuepress_notes_public/assets/js/6.cf4a0e04.js"><link rel="prefetch" href="/vuepress_notes_public/assets/js/7.c6ef01d7.js"><link rel="prefetch" href="/vuepress_notes_public/assets/js/8.e2170d55.js"><link rel="prefetch" href="/vuepress_notes_public/assets/js/9.528204ac.js">
    <link rel="stylesheet" href="/vuepress_notes_public/assets/css/0.styles.3d6faa3b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/vuepress_notes_public/" class="home-link router-link-active"><!----> <span class="site-name">......</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/vuepress_notes_public/" class="nav-link">Home</a></div><div class="nav-item"><a href="https://vuepress.vuejs.org/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  VuePress
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/vuepress_notes_public/" class="nav-link">Home</a></div><div class="nav-item"><a href="https://vuepress.vuejs.org/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  VuePress
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading"><span>js</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>ruby</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/vuepress_notes_public/ruby/sidekiq.html" class="active sidebar-link">分享之sidekiq</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuepress_notes_public/ruby/sidekiq.html#注意点" class="sidebar-link">注意点</a></li><li class="sidebar-sub-header"><a href="/vuepress_notes_public/ruby/sidekiq.html#处理过程" class="sidebar-link">处理过程</a></li><li class="sidebar-sub-header"><a href="/vuepress_notes_public/ruby/sidekiq.html#几个套路" class="sidebar-link">几个套路</a></li><li class="sidebar-sub-header"><a href="/vuepress_notes_public/ruby/sidekiq.html#参考文档" class="sidebar-link">参考文档</a></li></ul></li><li><a href="/vuepress_notes_public/ruby/ruby_decorator.html" class="sidebar-link">Python装饰器 与 Ruby实现</a></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="分享之sidekiq"><a href="#分享之sidekiq" aria-hidden="true" class="header-anchor">#</a> 分享之sidekiq</h1> <p>看过sidekiq源码的都说好。
架构明确，注释又多，而且基本都是短方法，阅读起来比较流畅。
真的挺好的。</p> <div class="language-ruby line-numbers-mode"><pre class="language-ruby"><code><span class="token comment"># launcher.rb</span>
<span class="token keyword">def</span> heartbeat
  results <span class="token operator">=</span> <span class="token constant">Sidekiq</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">CLI</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">PROCTITLES</span><span class="token punctuation">.</span>map <span class="token punctuation">{</span><span class="token operator">|</span>x<span class="token operator">|</span> x<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">,</span> to_data<span class="token punctuation">)</span> <span class="token punctuation">}</span>
  results<span class="token punctuation">.</span>compact<span class="token operator">!</span>
  $<span class="token number">0</span> <span class="token operator">=</span> results<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span>

  ❤
<span class="token keyword">end</span>

<span class="token comment"># sidekiq.rb</span>
<span class="token keyword">def</span> <span class="token keyword">self</span><span class="token punctuation">.</span>❨╯°□°❩╯︵┻━┻
  puts <span class="token string">&quot;Calm down, yo.&quot;</span>
<span class="token keyword">end</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h2 id="注意点"><a href="#注意点" aria-hidden="true" class="header-anchor">#</a> 注意点</h2> <p>一个后台任务的处理，无非就是把相关的参数存起来慢慢执行。几个点需要注意：</p> <ul><li>尽可能简单的参数。（考虑内存大小）</li> <li>可能会失败重试，是否幂等。</li> <li>是否涉及到并发。</li></ul> <p>这几个都是需要时刻考虑的地方。</p> <h2 id="处理过程"><a href="#处理过程" aria-hidden="true" class="header-anchor">#</a> 处理过程</h2> <h3 id="几个概念"><a href="#几个概念" aria-hidden="true" class="header-anchor">#</a> 几个概念</h3> <ol><li>Scheduled  poller =&gt; <code>Sidekiq::Scheduled::Poller</code>（拉取<code>retry：重试</code> 跟<code>schedule：延时</code>集合的任务推入队列）</li> <li>worker manager =&gt; <code>Sidekiq::Manager</code>（管理多个处理的任务队列的Processor）</li></ol> <h3 id="大致的思路"><a href="#大致的思路" aria-hidden="true" class="header-anchor">#</a> 大致的思路</h3> <ul><li>客户端将相关任务推入队列</li> <li><code>Sidekiq::Scheduled::Poller</code>  拉取  <code>retry：重试</code> 跟<code>schedule：延时</code>集合的任务推入队列</li> <li>启动多个Processor处理队列任务</li></ul> <div class="language-ruby line-numbers-mode"><pre class="language-ruby"><code><span class="token keyword">class</span> <span class="token class-name">HardWorker</span>
  include <span class="token constant">Sidekiq</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">Worker</span>
  <span class="token keyword">def</span> <span class="token function">perform</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> count<span class="token punctuation">)</span>
    <span class="token comment"># do something</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token constant">HardWorker</span><span class="token punctuation">.</span><span class="token function">perform_async</span><span class="token punctuation">(</span><span class="token string">'bob'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token comment"># 异步</span>
<span class="token constant">HardWorker</span><span class="token punctuation">.</span><span class="token function">perform_in</span><span class="token punctuation">(</span><span class="token number">5.</span>minutes<span class="token punctuation">,</span> <span class="token string">'bob'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token comment"># 延时异步</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h2 id="几个套路"><a href="#几个套路" aria-hidden="true" class="header-anchor">#</a> 几个套路</h2> <p>看源码的时候，发现里面涉及了很多不错的点。</p> <h3 id="处理延时任务"><a href="#处理延时任务" aria-hidden="true" class="header-anchor">#</a> 处理延时任务</h3> <p><code>perform_async</code> 与 <code>perform_in</code>的调用差不用，只是背后处理的时候，<code>perform_in</code> 会 加多一个 <code>at</code>参数。</p> <p>perform_in对应的格式是：</p> <div class="language-ruby line-numbers-mode"><pre class="language-ruby"><code>item <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">'class'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token constant">HardWorker</span><span class="token punctuation">,</span> <span class="token string">'args'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> args<span class="token punctuation">,</span> <span class="token string">'at'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> ts <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>perform_async对应的格式是：</p> <div class="language-ruby line-numbers-mode"><pre class="language-ruby"><code>item <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">'class'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token constant">HardWorker</span><span class="token punctuation">,</span> <span class="token string">'args'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> args <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>然后调用<code>Sidekiq::Client.new(pool).push(item)</code>，在push根据有没有<code>at</code>字段来做出不同的处理。</p> <blockquote><p>如果有<code>at</code>参数，加入到一个叫做<code>schedule</code>的集合中，等待 <code>Sidekiq::Scheduled::Poller</code> 拉取 再推入相应的队列当中，再等待<code>Processor</code>的处理。</p></blockquote> <blockquote><p>如果没有，则直接推入相应的队列当中，再等待<code>Processor</code>的处理。</p></blockquote> <div class="language-ruby line-numbers-mode"><pre class="language-ruby"><code><span class="token keyword">def</span> <span class="token function">atomic_push</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span> payloads<span class="token punctuation">)</span>
  <span class="token keyword">if</span> payloads<span class="token punctuation">.</span>first<span class="token punctuation">[</span><span class="token string">'at'</span><span class="token punctuation">]</span>  <span class="token comment"># ==&gt; here</span>
    conn<span class="token punctuation">.</span><span class="token function">zadd</span><span class="token punctuation">(</span><span class="token string">'schedule'</span><span class="token punctuation">,</span> payloads<span class="token punctuation">.</span>map <span class="token keyword">do</span> <span class="token operator">|</span>hash<span class="token operator">|</span>
      at <span class="token operator">=</span> hash<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">'at'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to_s
      <span class="token punctuation">[</span>at<span class="token punctuation">,</span> <span class="token constant">Sidekiq</span><span class="token punctuation">.</span><span class="token function">dump_json</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">end</span><span class="token punctuation">)</span>
  <span class="token keyword">else</span>              <span class="token comment"># ==&gt; here</span>
    q <span class="token operator">=</span> payloads<span class="token punctuation">.</span>first<span class="token punctuation">[</span><span class="token string">'queue'</span><span class="token punctuation">]</span>
    now <span class="token operator">=</span> <span class="token builtin">Time</span><span class="token punctuation">.</span>now<span class="token punctuation">.</span>to_f
    to_push <span class="token operator">=</span> payloads<span class="token punctuation">.</span>map <span class="token keyword">do</span> <span class="token operator">|</span>entry<span class="token operator">|</span>
      entry<span class="token punctuation">[</span><span class="token string">'enqueued_at'</span><span class="token punctuation">]</span> <span class="token operator">=</span> now
      <span class="token constant">Sidekiq</span><span class="token punctuation">.</span><span class="token function">dump_json</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span>
    <span class="token keyword">end</span>
    conn<span class="token punctuation">.</span><span class="token function">sadd</span><span class="token punctuation">(</span><span class="token string">'queues'</span><span class="token punctuation">,</span> q<span class="token punctuation">)</span>
    conn<span class="token punctuation">.</span><span class="token function">lpush</span><span class="token punctuation">(</span><span class="token string">&quot;queue:<span class="token interpolation"><span class="token delimiter tag">#{</span>q<span class="token delimiter tag">}</span></span>&quot;</span><span class="token punctuation">,</span> to_push<span class="token punctuation">)</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="策略模式"><a href="#策略模式" aria-hidden="true" class="header-anchor">#</a> 策略模式</h3> <p>sidekiq中，多处会提供自定义的能力。</p> <ul><li>Poller拉取器 拉取任务后 推入队列的策略</li></ul> <div class="language-ruby line-numbers-mode"><pre class="language-ruby"><code><span class="token keyword">class</span> <span class="token class-name">Enq</span>
  <span class="token keyword">def</span> <span class="token function">enqueue_jobs</span><span class="token punctuation">(</span>now<span class="token operator">=</span><span class="token builtin">Time</span><span class="token punctuation">.</span>now<span class="token punctuation">.</span>to_f<span class="token punctuation">.</span>to_s<span class="token punctuation">,</span> sorted_sets<span class="token operator">=</span><span class="token constant">SETS</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token keyword">class</span> <span class="token class-name">Poller</span>
  <span class="token keyword">def</span> initialize
    <span class="token variable">@enq</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token constant">Sidekiq</span><span class="token punctuation">.</span>options<span class="token punctuation">[</span><span class="token symbol">:scheduled_enq</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token constant">Sidekiq</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">Scheduled</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">Enq</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">new</span>
  <span class="token class-name">end</span>
<span class="token keyword">end</span>

<span class="token comment"># @enq.enqueue_jobs</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>Poller拉取器 拉取 <code>retry：重试</code> 跟<code>schedule：延时</code>集合的任务推入相关队列。默认是使用<code>Sidekiq::Scheduled::Enq</code>策略，每次使用一个时间作为score，在集合中获取匹配的第一个元素推入相关队列。
可以自行修改推入队列的方式。</p> <ul><li>Processor获取任务的策略</li></ul> <div class="language-ruby line-numbers-mode"><pre class="language-ruby"><code><span class="token keyword">class</span> <span class="token class-name">Processor</span>
  <span class="token keyword">def</span> <span class="token function">initialize</span><span class="token punctuation">(</span>mgr<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token variable">@strategy</span> <span class="token operator">=</span> <span class="token punctuation">(</span>mgr<span class="token punctuation">.</span>options<span class="token punctuation">[</span><span class="token symbol">:fetch</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token constant">Sidekiq</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">BasicFetch</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>mgr<span class="token punctuation">.</span>options<span class="token punctuation">)</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token comment"># work = @strategy.retrieve_work</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>每个Processor取出一个任务时，通过<code>@strategy = (mgr.options[:fetch] || Sidekiq::BasicFetch).new(mgr.options)</code> 这个策略来获取，优先级的处理就是在这块处理的。
如果不传入新的获取任务策略，则使用<code>Sidekiq::BasicFetch</code>当做默认策略。</p> <h3 id="权重-——-优先级"><a href="#权重-——-优先级" aria-hidden="true" class="header-anchor">#</a> 权重 —— 优先级</h3> <p>在sidekiq中，各个队列可以通过配置权重，实现优先级。
写在启动参数中：</p> <div class="language-ruby line-numbers-mode"><pre class="language-ruby"><code><span class="token comment"># 格式 =&gt; sidekiq -q 队列名,权重</span>
sidekiq <span class="token operator">-</span>q critical<span class="token punctuation">,</span><span class="token number">2</span> <span class="token operator">-</span>q default
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>也可以写在配置文件中：</p> <div class="language-ruby line-numbers-mode"><pre class="language-ruby"><code><span class="token comment"># sidekiq.yml</span>

<span class="token symbol">:queues</span><span class="token punctuation">:</span>
  <span class="token operator">-</span> <span class="token punctuation">[</span>critical<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>
  <span class="token operator">-</span> default

<span class="token comment"># 启动</span>
sidekiq <span class="token operator">-</span><span class="token constant">C</span> sidekiq<span class="token punctuation">.</span>yml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><blockquote><p>Note：只要有一个队列配置了权重，那么整个sidekiq处理任务的时候，将不再按照队列声明的顺序来执行。</p></blockquote> <p>如果想要按顺序来处理，不要指定权重即可：</p> <div class="language-ruby line-numbers-mode"><pre class="language-ruby"><code>sidekiq <span class="token operator">-</span>q critical <span class="token operator">-</span>q default <span class="token operator">-</span>q low
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>如果想要各个队列随机平等处理，则配置权重都为1：</p> <div class="language-ruby line-numbers-mode"><pre class="language-ruby"><code>sidekiq <span class="token operator">-</span>q critical<span class="token punctuation">,</span><span class="token number">1</span> <span class="token operator">-</span>q default<span class="token punctuation">,</span><span class="token number">1</span> <span class="token operator">-</span>q low<span class="token punctuation">,</span><span class="token number">1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>为什么会是这样？ sidekiq内部是如何处理的？
下面来看看，会发现思路的也是很简单的。</p> <p>sidekiq启动时，会解析传入的参数 — — 要么是带在命令行，要么是写在配置文件，就是开头说的那两种方式。</p> <div class="language-ruby line-numbers-mode"><pre class="language-ruby"><code><span class="token comment"># cli.rb</span>
<span class="token keyword">def</span> <span class="token function">parse_queue</span><span class="token punctuation">(</span>opts<span class="token punctuation">,</span> q<span class="token punctuation">,</span> weight<span class="token operator">=</span><span class="token keyword">nil</span><span class="token punctuation">)</span>
  <span class="token punctuation">[</span>weight<span class="token punctuation">.</span>to_i<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>max<span class="token punctuation">.</span>times <span class="token keyword">do</span>
    <span class="token punctuation">(</span>opts<span class="token punctuation">[</span><span class="token symbol">:queues</span><span class="token punctuation">]</span> <span class="token operator">||</span><span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span><span class="token operator">&lt;</span> q
  <span class="token keyword">end</span>
  opts<span class="token punctuation">[</span><span class="token symbol">:strict</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">false</span> <span class="token keyword">if</span> weight<span class="token punctuation">.</span>to_i <span class="token operator">&gt;</span> <span class="token number">0</span>
<span class="token keyword">end</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>生成两个参数：</p> <ul><li>opts[:queues]
根据权重构造queue_name数组。</li></ul> <div class="language-ruby line-numbers-mode"><pre class="language-ruby"><code>sidekiq <span class="token operator">-</span>q critical<span class="token punctuation">,</span><span class="token number">3</span> <span class="token operator">-</span>q default<span class="token punctuation">,</span><span class="token number">2</span> <span class="token operator">-</span>q low<span class="token punctuation">,</span><span class="token number">1</span>

opts<span class="token punctuation">[</span><span class="token symbol">:queues</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>critical<span class="token punctuation">,</span> critical<span class="token punctuation">,</span> critical<span class="token punctuation">,</span> default<span class="token punctuation">,</span> default<span class="token punctuation">,</span> low<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>opts[:strict]
队列是否按顺序。
如果其中有一个队列有权重配置，则 <code>opts[:strict] = false</code></li></ul> <p>在弹出任务的时候，会传入这些参数。</p> <div class="language-ruby line-numbers-mode"><pre class="language-ruby"><code><span class="token comment"># fetch.rb</span>
<span class="token keyword">class</span> <span class="token class-name">BasicFetch</span>
  <span class="token keyword">def</span> <span class="token function">initialize</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
    <span class="token variable">@strictly_ordered_queues</span> <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>options<span class="token punctuation">[</span><span class="token symbol">:strict</span><span class="token punctuation">]</span>
    <span class="token variable">@queues</span> <span class="token operator">=</span> options<span class="token punctuation">[</span><span class="token symbol">:queues</span><span class="token punctuation">]</span><span class="token punctuation">.</span>map <span class="token punctuation">{</span> <span class="token operator">|</span>q<span class="token operator">|</span> <span class="token string">&quot;queue:<span class="token interpolation"><span class="token delimiter tag">#{</span>q<span class="token delimiter tag">}</span></span>&quot;</span> <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token variable">@strictly_ordered_queues</span>
      <span class="token variable">@queues</span> <span class="token operator">=</span> <span class="token variable">@queues</span><span class="token punctuation">.</span>uniq
      <span class="token variable">@queues</span> <span class="token operator">&lt;</span><span class="token operator">&lt;</span> <span class="token constant">TIMEOUT</span>
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>

  <span class="token keyword">def</span> retrieve_work
    work <span class="token operator">=</span> <span class="token constant">Sidekiq</span><span class="token punctuation">.</span>redis <span class="token punctuation">{</span> <span class="token operator">|</span>conn<span class="token operator">|</span> conn<span class="token punctuation">.</span><span class="token function">brpop</span><span class="token punctuation">(</span><span class="token operator">*</span>queues_cmd<span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token constant">UnitOfWork</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token operator">*</span>work<span class="token punctuation">)</span> <span class="token keyword">if</span> work
  <span class="token keyword">end</span>

  <span class="token comment"># Creating the Redis#brpop command takes into account any</span>
  <span class="token comment"># configured queue weights. By default Redis#brpop returns</span>
  <span class="token comment"># data from the first queue that has pending elements. We</span>
  <span class="token comment"># recreate the queue command each time we invoke Redis#brpop</span>
  <span class="token comment"># to honor weights and avoid queue starvation.</span>
  <span class="token keyword">def</span> queues_cmd
    <span class="token keyword">if</span> <span class="token variable">@strictly_ordered_queues</span>
      <span class="token variable">@queues</span>
    <span class="token keyword">else</span>
      queues <span class="token operator">=</span> <span class="token variable">@queues</span><span class="token punctuation">.</span>shuffle<span class="token punctuation">.</span>uniq
      queues <span class="token operator">&lt;</span><span class="token operator">&lt;</span> <span class="token constant">TIMEOUT</span>
      queues
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>当配有权重时，会先打乱再去重。</p> <blockquote><p>queues = @queues.shuffle.uniq
权重大的，排在前面的概率大，率先执行的概率也就大。</p></blockquote> <p>然后配合redis的<code>brpop</code>：</p> <blockquote><p>redis.brpop(queue1, queue2, time_out)
可以给定一组列表 queue_a， queue_b， queue_c，在加上一个超时时间。
会依次检查列表，直到找到一个元素 或者 超时 或者 一直阻塞着（没有设置超时时间）。</p> <p>sidekiq配合Redis 使用起来十分方便。</p></blockquote> <p>这就是sidekiq处理优先级的方式。</p> <h3 id="中间件"><a href="#中间件" aria-hidden="true" class="header-anchor">#</a> 中间件</h3> <p>客户端推进一个任务时，会经过一些参数格式化（如生成对应的入队列格式，添加任务的自定义id等 ）。
sidekiq允许自定义一些入队列前的操作，通过中间件来实现。比如：<code>添加入队列前的参数</code> 或者 <code>根据条件，过滤掉任务，阻止任务入队列</code> 等等。</p> <p>中间件可以分两种</p> <ul><li>全局的：直接Sidekiq的config添加。</li></ul> <div class="language-ruby line-numbers-mode"><pre class="language-ruby"><code><span class="token constant">Sidekiq</span><span class="token punctuation">.</span>configure_server <span class="token keyword">do</span> <span class="token operator">|</span>config<span class="token operator">|</span>
  config<span class="token punctuation">.</span>client_middleware <span class="token keyword">do</span> <span class="token operator">|</span>chain<span class="token operator">|</span>
    chain<span class="token punctuation">.</span>add <span class="token constant">MyClientMiddleware</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>局部的：针对当个client添加。</li></ul> <div class="language-ruby line-numbers-mode"><pre class="language-ruby"><code>client <span class="token operator">=</span> <span class="token constant">Sidekiq</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">Client</span><span class="token punctuation">.</span><span class="token keyword">new</span>
<span class="token class-name">client<span class="token punctuation">.</span>middleware</span> <span class="token keyword">do</span> <span class="token operator">|</span>chain<span class="token operator">|</span>
  chain<span class="token punctuation">.</span>use <span class="token constant">MyClientMiddleware</span>
<span class="token keyword">end</span>
client<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'class'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'SomeWorker'</span><span class="token punctuation">,</span> <span class="token string">'args'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>每个client走过的中间件是 <code>全局的 + 局部的</code>。</p> <p>如何实现？</p> <div class="language-ruby line-numbers-mode"><pre class="language-ruby"><code><span class="token comment"># client.rb</span>
<span class="token keyword">module</span> <span class="token constant">Sidekiq</span>
  <span class="token keyword">class</span> <span class="token class-name">Client</span>
    <span class="token keyword">def</span> <span class="token function">middleware</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>block<span class="token punctuation">)</span>
      <span class="token variable">@chain</span> <span class="token operator">||</span><span class="token operator">=</span> <span class="token constant">Sidekiq</span><span class="token punctuation">.</span>client_middleware <span class="token comment"># 先将全局的加进来~</span>
      <span class="token keyword">if</span> block_given<span class="token operator">?</span> <span class="token comment"># 这里添加局部中间件的处理</span>
        <span class="token variable">@chain</span> <span class="token operator">=</span> <span class="token variable">@chain</span><span class="token punctuation">.</span>dup
        <span class="token keyword">yield</span> <span class="token variable">@chain</span>
      <span class="token keyword">end</span>
      <span class="token variable">@chain</span> <span class="token comment"># chain存了该client相关的中间件</span>
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>创建一个<code>Client实例</code>时，该<code>client</code>已经将所有需要的中间件存在一个chain里面等待调用。
而执行中间件的调用时，通过一个精简的递归就将所有中间件执行。</p> <p>调用的时候：</p> <div class="language-ruby line-numbers-mode"><pre class="language-ruby"><code><span class="token comment"># client.rb</span>
middleware<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>worker_class<span class="token punctuation">,</span> item<span class="token punctuation">,</span> queue<span class="token punctuation">,</span> <span class="token variable">@redis_pool</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
  item
<span class="token keyword">end</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>client.middleware返回一个chain。<code>chain.invoke</code>定义如下：</p> <div class="language-ruby line-numbers-mode"><pre class="language-ruby"><code><span class="token comment"># chain.rb</span>
<span class="token keyword">def</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">)</span>
  chain <span class="token operator">=</span> retrieve<span class="token punctuation">.</span>dup
  traverse_chain <span class="token operator">=</span> lambda <span class="token keyword">do</span>
    <span class="token keyword">if</span> chain<span class="token punctuation">.</span>empty<span class="token operator">?</span>
      <span class="token keyword">yield</span>
    <span class="token keyword">else</span>
      chain<span class="token punctuation">.</span>shift<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">&amp;</span>traverse_chain<span class="token punctuation">)</span> <span class="token comment"># 每次弹出最前的middleware并进行递归，这样中间件一层一层嵌套</span>
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>
  traverse_chain<span class="token punctuation">.</span>call <span class="token comment"># 执行</span>
<span class="token keyword">end</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><blockquote><p>NOTE-1：既然都给 lambda命名了，为啥不使用def 定义呢？
我想是直接使用闭包，不用将剩余的chain暴露出来。</p></blockquote> <p>sidekiq的中间件跟Rack的中间件定义很像：</p> <ul><li>能够响应call</li> <li>接收特定的参数供层级传递</li></ul> <div class="language-ruby line-numbers-mode"><pre class="language-ruby"><code><span class="token keyword">class</span> <span class="token class-name">MyClientMiddleware</span>
  <span class="token keyword">def</span> <span class="token function">call</span><span class="token punctuation">(</span>worker_class<span class="token punctuation">,</span> job<span class="token punctuation">,</span> queue<span class="token punctuation">,</span> redis_pool<span class="token punctuation">)</span>
    <span class="token comment"># return false/nil to stop the job from going to redis</span>
    <span class="token keyword">return</span> <span class="token keyword">false</span> <span class="token keyword">if</span> queue <span class="token operator">!=</span> <span class="token string">'default'</span>
    job<span class="token punctuation">[</span><span class="token string">'customer'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">Customer</span><span class="token punctuation">.</span>current_id
    <span class="token keyword">yield</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><blockquote><p>NOTE-2：中间件的yield位置很重要，最好位于最后当做返回值。
另外提前return可以阻止继续往下层传递，提交跳出chain。</p></blockquote> <h3 id="时间间隔的利用"><a href="#时间间隔的利用" aria-hidden="true" class="header-anchor">#</a> 时间间隔的利用</h3> <p>每个sidekiq进程启动时，会启动相关的Poller，<code>initial_wait</code>加入一个随机时间避免或减少同时请求IO。</p> <div class="language-ruby line-numbers-mode"><pre class="language-ruby"><code><span class="token keyword">class</span> <span class="token class-name">Poller</span>
  <span class="token keyword">def</span> start
    <span class="token variable">@thread</span> <span class="token operator">||</span><span class="token operator">=</span> <span class="token function">safe_thread</span><span class="token punctuation">(</span><span class="token string">&quot;scheduler&quot;</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
      initial_wait   <span class="token comment"># ==&gt; here</span>

      <span class="token keyword">while</span> <span class="token operator">!</span><span class="token variable">@done</span>
        enqueue
        wait       <span class="token comment"># ==&gt; here</span>
      <span class="token keyword">end</span>
      <span class="token constant">Sidekiq</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Scheduler exiting...&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>

  <span class="token keyword">def</span> initial_wait
    <span class="token comment"># Have all processes sleep between 5-15 seconds.  10 seconds</span>
    <span class="token comment"># to give time for the heartbeat to register (if the poll interval is going to be calculated by the number</span>
    <span class="token comment"># of workers), and 5 random seconds to ensure they don't all hit Redis at the same time.</span>
    total <span class="token operator">=</span> <span class="token number">0</span>
    total <span class="token operator">+</span><span class="token operator">=</span> <span class="token constant">INITIAL_WAIT</span> <span class="token keyword">unless</span> <span class="token constant">Sidekiq</span><span class="token punctuation">.</span>options<span class="token punctuation">[</span><span class="token symbol">:poll_interval_average</span><span class="token punctuation">]</span>
    total <span class="token operator">+</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">*</span> rand<span class="token punctuation">)</span>

    <span class="token variable">@sleeper</span><span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span>total<span class="token punctuation">)</span>
  <span class="token keyword">rescue</span> <span class="token constant">Timeout</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">Error</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>在拉取<code>retry：重试</code> 跟<code>schedule：延时</code>集合的一个任务推入队列之后，就
休眠一段时间。而这时间不是固定的。</p> <div class="language-ruby line-numbers-mode"><pre class="language-ruby"><code><span class="token keyword">def</span> wait
   <span class="token variable">@sleeper</span><span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span>random_poll_interval<span class="token punctuation">)</span>
  <span class="token keyword">rescue</span> <span class="token constant">Timeout</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">Error</span>
    <span class="token comment"># expected</span>
  <span class="token keyword">rescue</span> <span class="token operator">=</span><span class="token operator">&gt;</span> ex
    <span class="token comment"># if poll_interval_average hasn't been calculated yet, we can</span>
    <span class="token comment"># raise an error trying to reach Redis.</span>
    logger<span class="token punctuation">.</span>error ex<span class="token punctuation">.</span>message
    <span class="token function">handle_exception</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span>
    sleep <span class="token number">5</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><div class="language-ruby line-numbers-mode"><pre class="language-ruby"><code><span class="token comment"># Calculates a random interval that is ±50% the desired average.</span>
<span class="token keyword">def</span> random_poll_interval
  poll_interval_average <span class="token operator">*</span> rand <span class="token operator">+</span> poll_interval_average<span class="token punctuation">.</span>to_f <span class="token operator">/</span> <span class="token number">2</span>
<span class="token keyword">end</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>poll_interval_average =&gt; 决定延时任务定期检查的平均时间周期。
直接看这一大段注释也可以很爽！！！！！</p> <div class="language-ruby line-numbers-mode"><pre class="language-ruby"><code><span class="token comment"># We do our best to tune the poll interval to the size of the active Sidekiq</span>
<span class="token comment"># cluster.  If you have 30 processes and poll every 15 seconds, that means one</span>
<span class="token comment"># Sidekiq is checking Redis every 0.5 seconds - way too often for most people</span>
<span class="token comment"># and really bad if the retry or scheduled sets are large.</span>
<span class="token comment">#</span>
<span class="token comment"># Instead try to avoid polling more than once every 15 seconds.  If you have</span>
<span class="token comment"># 30 Sidekiq processes, we'll poll every 30 * 15 or 450 seconds.</span>
<span class="token comment"># To keep things statistically random, we will sleep a random amount between</span>
<span class="token comment"># 225 and 675 seconds for each poll or 450 seconds on average.  Otherwise restarting</span>
<span class="token comment"># all your Sidekiq processes at the same time will lead to them all polling at</span>
<span class="token comment"># the same time: the thundering herd problem.</span>
<span class="token comment">#</span>
<span class="token comment"># We only do this if poll_interval_average is unset (the default).</span>
<span class="token keyword">def</span> poll_interval_average
  <span class="token constant">Sidekiq</span><span class="token punctuation">.</span>options<span class="token punctuation">[</span><span class="token symbol">:poll_interval_average</span><span class="token punctuation">]</span> <span class="token operator">||</span><span class="token operator">=</span> scaled_poll_interval
<span class="token keyword">end</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>根据你开启的sidekiq的进程数计算</p> <div class="language-ruby line-numbers-mode"><pre class="language-ruby"><code><span class="token comment"># Calculates an average poll interval based on the number of known Sidekiq processes.</span>
<span class="token comment"># This minimizes a single point of failure by dispersing check-ins but without taxing</span>
<span class="token comment"># Redis if you run many Sidekiq processes.</span>
<span class="token keyword">def</span> scaled_poll_interval
  pcount <span class="token operator">=</span> <span class="token constant">Sidekiq</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">ProcessSet</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">.</span>size
  pcount <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">if</span> pcount <span class="token operator">==</span> <span class="token number">0</span>
  pcount <span class="token operator">*</span> <span class="token constant">Sidekiq</span><span class="token punctuation">.</span>options<span class="token punctuation">[</span><span class="token symbol">:average_scheduled_poll_interval</span><span class="token punctuation">]</span>
<span class="token keyword">end</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="其它点"><a href="#其它点" aria-hidden="true" class="header-anchor">#</a> 其它点</h3> <p>当然，还涉及到许多其它的点，后续待跟。像：</p> <ul><li>Redis各种数据结构在sidekiq的使用</li> <li>任务如何重试</li> <li>当任务处理一半收到停止信号如何处理</li> <li>一个Processor挂了之后如何处理</li> <li>队列堆积怎么处理</li> <li>……</li></ul> <hr> <h2 id="参考文档"><a href="#参考文档" aria-hidden="true" class="header-anchor">#</a> 参考文档</h2> <p>好文推荐，图文并茂呢，将sidekiq的处理过程讲得很明白~</p> <ul><li><a href="https://github.com/mperham/sidekiq/wiki" target="_blank" rel="noopener noreferrer">Home · mperham/sidekiq Wiki · GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://draveness.me/sidekiq" target="_blank" rel="noopener noreferrer">Sidekiq 如何处理异步任务<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://ruby-china.org/topics/31470" target="_blank" rel="noopener noreferrer">Sidekiq 任务调度流程分析 · Ruby China<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/vuepress_notes_public/reactivity_demo/reactivity.html" class="prev">
          响应式数据
        </a></span> <span class="next"><a href="/vuepress_notes_public/ruby/ruby_decorator.html">
          Python装饰器 与 Ruby实现
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/vuepress_notes_public/assets/js/13.22af0d65.js" defer></script><script src="/vuepress_notes_public/assets/js/app.2153f277.js" defer></script>
  </body>
</html>
